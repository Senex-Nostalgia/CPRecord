<h2>题目描述</h2>
<p>scx 非常喜欢画画，它总是喜欢给树染上各种各样的漂亮的颜色。</p>
<p>今天，她又在给一棵树染色。这是一棵有 <i>n</i> 个节点的，以 1 号点为根的有根树，第 <i>i</i> 个节点被她染成了颜色 <i>c<sub>i</sub></i>。</p>
<p>定义 dep<i><sub>i</sub></i> 为节点 <i>i</i> 到根 (1 号点) 的距离，其中，每条树边的长度为 1。</p>
<p>站在那棵漂亮的树面前，scx 想问你 <i>m</i> 个问题。</p>
<p>每个问题中，她给出两个整数 <i>x</i> 和 <i>d</i>，意思是想知道节点集合 <i>S</i> 中对应的颜色的总数，其中 <img src="http://latex.codecogs.com/gif.latex?S=\left\{v\mid%20v\in\mathrm{subtree}(x)\wedge\mathrm{dep}_v\leq\mathrm{dep}_x+d\right\}">。</p>

<h2>输入格式</h2>
<p>第一行包含一个正整数 <i>T</i> (1 ≤ <i>T</i> ≤ 500)，表示数据组数。</p>
<p>在每一组数据，第一行有两个正整数 <i>n</i>, <i>m</i> (1 ≤ <i>n</i>, <i>m</i> ≤ 10<sup>5</sup>)，意义如描述所述。</p>
<p>第二行包含 <i>n</i> 个整数 <i>c<sub>i</sub></i> (1 ≤ <i>c<sub>i</sub></i> ≤ <i>n</i>)，意义如描述所述。</p>
<p>第三行包含 <i>n</i> - 1 个整数，第 <i>i</i> 个整数 <i>f</i><sub><i>i</i> + 1</sub> (1 ≤ <i>f</i><sub><i>i</i> + 1</sub> ≤ <i>i</i>) 表示节点 <i>i</i> + 1 的父节点。</p>
<p>接下来的 <i>m</i> 行，每行两个整数 <i>x</i>' 和 <i>d</i>'，意义如描述所述。</p>
<p>本题强制在线，所以<b>每组数据</b>从第二组询问开始 <img src="http://latex.codecogs.com/gif.latex?x=x'\oplus\mathrm{ans},d=d'\oplus\mathrm{ans}">，其中 ans 代表上一次询问的答案，满足 1 ≤ <i>x</i> ≤ <i>n</i>, 0 ≤ <i>d</i> &lt; <i>n</i>。</p>

<h2>输出格式</h2>
<p>对于每组询问，输出一行一个整数，表示答案。</p>

<h2>题解</h2>
<p>先考虑没有右边这个条件，也就是 <i>x</i> 的子树中颜色的总数。</p>
<p>那么先 dfs 一遍，用 set 记录每种颜色所对应节点的 dfs 序集合。</p>
<p>每加入一个点 <i>i</i>，若 <i>c<sub>i</sub></i> 没有出现过，可以看到，从根 (点 1) 到点 <i>i</i> 的路径上所有点的答案全都要 + 1。</p>
<p>如果 <i>c<sub>i</sub></i> 出现过，记它在 dfs 序中前一次、后一次出现的点为 <i>l</i>, <i>r</i>。记 <i>L</i> = lca(<i>i</i>, <i>l</i>), <i>R</i> = lca(<i>i</i>, <i>r</i>), 显然 <i>L</i>, <i>R</i> 为祖先和子孙的关系 (当然可能是同一个点啦)，记 <i>v</i> 为 <i>L</i>, <i>R</i> 中深度 (<code>dep[]</code>) 值较大的那个，可以发现，从点 <i>v</i> 到点 <i>i</i> 的路径上除 <i>v</i> 外所有点的答案全都要 + 1。</p>
<p>由于是链上修改，单点查询，<s>很显然滴</s>做一个树上差分，变成单点修改，子树权值和查询。由 dfs 序的性质可以知道，以任何一个点 <i>v</i> 为根的子树中，所有点的 dfs 序是连续的，所以可以轻松用线段树搞定。</p>
<p>现在考虑加上这个条件。可以<s>显然</s>得到，这个其实就是<b>只加点到 dep<sub>x</sub> + <i>d</i> 时</b>的答案，所以如果可以离线显然用莫队，在线呢？当然是可持久化线段树啦~</p>
<p>所以加点的时候，要按照深度一层一层加点，记录每加完一层的时间戳，询问时，就直接输出那时候的可持久化线段树的值了。</p>

<h2>代码</h2>

<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> N <span class="sh_number">100034</span>
<span class="sh_preproc">#define</span> next scx1
<span class="sh_preproc">#define</span> stime scx2
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">typedef</span> set <span class="sh_symbol">&lt;</span><span class="sh_type">int</span><span class="sh_symbol">&gt;</span> Set<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">STex</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> sz<span class="sh_symbol">,</span> cnt<span class="sh_symbol">,</span> tim<span class="sh_symbol">;</span>
    <span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">node</span><span class="sh_cbracket">{</span><span class="sh_type">int</span> lc<span class="sh_symbol">,</span> rc<span class="sh_symbol">,</span> v<span class="sh_symbol">;</span><span class="sh_cbracket">}</span><span class="sh_symbol">*</span>x<span class="sh_symbol">;</span>
    <span class="sh_type">int</span> <span class="sh_symbol">*</span>root<span class="sh_symbol">;</span>
    <span class="sh_function">STex</span> <span class="sh_symbol">():</span> <span class="sh_function">sz</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">),</span> <span class="sh_function">cnt</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">),</span> <span class="sh_function">tim</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>x <span class="sh_symbol">=</span> NULL<span class="sh_symbol">;</span> root <span class="sh_symbol">=</span> NULL<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_symbol">~</span><span class="sh_function">STex</span> <span class="sh_symbol">()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>x<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span>root<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> root<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">resize</span><span class="sh_symbol">(</span><span class="sh_type">int</span> size<span class="sh_symbol">,</span> <span class="sh_type">int</span> timest<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        sz <span class="sh_symbol">=</span> size<span class="sh_symbol">;</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span>x<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_type">int</span> sz0 <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>sz <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">+</span> sz <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">4</span><span class="sh_symbol">;</span> <span class="sh_comment">// 48sz</span>
        x <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> node<span class="sh_symbol">[</span>sz0<span class="sh_symbol">];</span> <span class="sh_function">memset</span><span class="sh_symbol">(</span>x<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> sz0 <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">2</span><span class="sh_symbol">);</span>
        <span class="sh_type">int</span> tim0 <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>timest <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">+</span> timest <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">3</span><span class="sh_symbol">;</span> <span class="sh_comment">// 24t</span>
        root <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> <span class="sh_type">int</span><span class="sh_symbol">[</span>tim0<span class="sh_symbol">];</span> <span class="sh_function">memset</span><span class="sh_symbol">(</span>root<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> tim0 <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">2</span><span class="sh_symbol">);</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">init</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>cnt <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> root<span class="sh_symbol">[</span>tim <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">build</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">,</span> sz<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">add</span><span class="sh_symbol">(</span><span class="sh_type">int</span> h<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_symbol">++</span>tim<span class="sh_symbol">;</span> root<span class="sh_symbol">[</span>tim<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>root<span class="sh_symbol">[</span>tim <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">],</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> sz<span class="sh_symbol">,</span> h<span class="sh_symbol">,</span> v<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">int</span> <span class="sh_function">range</span><span class="sh_symbol">(</span><span class="sh_type">int</span> l<span class="sh_symbol">,</span> <span class="sh_type">int</span> r<span class="sh_symbol">,</span> <span class="sh_type">int</span> rtime <span class="sh_symbol">=</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_function">query</span><span class="sh_symbol">(</span>root<span class="sh_symbol">[~</span>rtime <span class="sh_symbol">?</span> rtime <span class="sh_symbol">:</span> tim<span class="sh_symbol">],</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> sz<span class="sh_symbol">,</span> l<span class="sh_symbol">,</span> r<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">int</span> <span class="sh_function">build</span><span class="sh_symbol">(</span><span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_type">int</span> id <span class="sh_symbol">=</span> <span class="sh_symbol">++</span>cnt<span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">==</span> R<span class="sh_symbol">)</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>v <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">else</span><span class="sh_cbracket">{</span>
            <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
            x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>lc <span class="sh_symbol">=</span> <span class="sh_function">build</span><span class="sh_symbol">(</span>L<span class="sh_symbol">,</span> M<span class="sh_symbol">);</span>
            x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>rc <span class="sh_symbol">=</span> <span class="sh_function">build</span><span class="sh_symbol">(</span>M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
        <span class="sh_keyword">return</span> id<span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">int</span> <span class="sh_function">add</span><span class="sh_symbol">(</span><span class="sh_type">int</span> _id<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">,</span> <span class="sh_type">int</span> h<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_type">int</span> id <span class="sh_symbol">=</span> <span class="sh_symbol">++</span>cnt<span class="sh_symbol">;</span>
        x<span class="sh_symbol">[</span>id<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> x<span class="sh_symbol">[</span>_id<span class="sh_symbol">];</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>v <span class="sh_symbol">+=</span> v<span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">&lt;</span> R<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
            <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>h <span class="sh_symbol">&lt;=</span> M<span class="sh_symbol">)</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>lc <span class="sh_symbol">=</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">,</span> h<span class="sh_symbol">,</span> v<span class="sh_symbol">);</span>
            <span class="sh_keyword">else</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>rc <span class="sh_symbol">=</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">,</span> h<span class="sh_symbol">,</span> v<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
        <span class="sh_keyword">return</span> id<span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">int</span> <span class="sh_function">query</span><span class="sh_symbol">(</span><span class="sh_type">int</span> id<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">,</span> <span class="sh_type">int</span> ql<span class="sh_symbol">,</span> <span class="sh_type">int</span> qr<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>ql <span class="sh_symbol">&gt;</span> R <span class="sh_symbol">||</span> qr <span class="sh_symbol">&lt;</span> L<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>ql <span class="sh_symbol">&lt;=</span> L <span class="sh_symbol">&amp;&amp;</span> qr <span class="sh_symbol">&gt;=</span> R<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>v<span class="sh_symbol">;</span>
        <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> s <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>ql <span class="sh_symbol">&lt;=</span> M<span class="sh_symbol">)</span> s <span class="sh_symbol">+=</span> <span class="sh_function">query</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">,</span> ql<span class="sh_symbol">,</span> <span class="sh_function">min</span><span class="sh_symbol">(</span>qr<span class="sh_symbol">,</span> M<span class="sh_symbol">));</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>qr <span class="sh_symbol">&gt;</span> M<span class="sh_symbol">)</span> s <span class="sh_symbol">+=</span> <span class="sh_function">query</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">,</span> ql<span class="sh_symbol">,</span> <span class="sh_function">max</span><span class="sh_symbol">(</span>qr<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">));</span>
        <span class="sh_keyword">return</span> s<span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_type">int</span> n<span class="sh_symbol">,</span> q<span class="sh_symbol">,</span> i<span class="sh_symbol">,</span> E<span class="sh_symbol">;</span>
<span class="sh_type">int</span> x<span class="sh_symbol">,</span> d<span class="sh_symbol">,</span> col<span class="sh_symbol">,</span> ans<span class="sh_symbol">;</span>
<span class="sh_type">int</span> c<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_comment">// adjacent list </span>
<span class="sh_type">int</span> first<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> next<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> to<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_comment">// traversal of tree</span>
<span class="sh_type">int</span> cnt<span class="sh_symbol">,</span> depth<span class="sh_symbol">,</span> id<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> dep<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> lr_bd<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> up_bd<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_type">int</span> adod<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> P<span class="sh_symbol">[</span>N<span class="sh_symbol">][</span><span class="sh_number">18</span><span class="sh_symbol">];</span>
<span class="sh_comment">// set stores colors</span>
<span class="sh_usertype">Set</span><span class="sh_normal"> </span>cs<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
Set<span class="sh_symbol">::</span><span class="sh_usertype">iterator</span><span class="sh_normal"> </span>it<span class="sh_symbol">,</span> jt<span class="sh_symbol">;</span>
<span class="sh_type">int</span> lci<span class="sh_symbol">,</span> lcj<span class="sh_symbol">;</span>
<span class="sh_comment">// persistent segment tree</span>
<span class="sh_usertype">STex</span><span class="sh_normal"> </span>st<span class="sh_symbol">;</span>
<span class="sh_type">int</span> stime<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">addedge</span><span class="sh_symbol">(</span><span class="sh_type">int</span> u<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>to<span class="sh_symbol">[++</span>E<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> v<span class="sh_symbol">;</span> next<span class="sh_symbol">[</span>E<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>u<span class="sh_symbol">];</span> first<span class="sh_symbol">[</span>u<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> E<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_keyword">inline</span> <span class="sh_type">bool</span> <span class="sh_function">cmp</span><span class="sh_symbol">(</span><span class="sh_keyword">const</span> <span class="sh_type">int</span> <span class="sh_symbol">&amp;</span>u<span class="sh_symbol">,</span> <span class="sh_keyword">const</span> <span class="sh_type">int</span> <span class="sh_symbol">&amp;</span>v<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> dep<span class="sh_symbol">[</span>u<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> dep<span class="sh_symbol">[</span>v<span class="sh_symbol">];</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> y<span class="sh_symbol">;</span>
    id<span class="sh_symbol">[++</span>cnt<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> x<span class="sh_symbol">;</span>
    lr_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cnt<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">17</span> <span class="sh_symbol">&amp;&amp;</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span>
        P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">][</span>P<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>x<span class="sh_symbol">];</span> i<span class="sh_symbol">;</span> i <span class="sh_symbol">=</span> next<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">((</span>y <span class="sh_symbol">=</span> to<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span> <span class="sh_symbol">!=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">])</span><span class="sh_cbracket">{</span>
            dep<span class="sh_symbol">[</span>y<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span>y<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
    up_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cnt<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">LCA</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> dep<span class="sh_symbol">[</span>y<span class="sh_symbol">])</span> <span class="sh_function">swap</span><span class="sh_symbol">(</span>x<span class="sh_symbol">,</span> y<span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">17</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i<span class="sh_symbol">--)</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">-</span> <span class="sh_symbol">(</span><span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> i<span class="sh_symbol">)</span> <span class="sh_symbol">&gt;=</span> dep<span class="sh_symbol">[</span>y<span class="sh_symbol">])</span>
            x <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>x <span class="sh_symbol">==</span> y<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> x<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">17</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i<span class="sh_symbol">--)</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">!=</span> P<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span>i<span class="sh_symbol">])</span><span class="sh_cbracket">{</span>
            x <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span> y <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span>y<span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_keyword">return</span> P<span class="sh_symbol">[</span>x<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">];</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> T<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>T<span class="sh_symbol">);</span> T<span class="sh_symbol">;</span> T<span class="sh_symbol">--)</span><span class="sh_cbracket">{</span>
        <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>n<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>q<span class="sh_symbol">);</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> c <span class="sh_symbol">+</span> i<span class="sh_symbol">);</span>
        E <span class="sh_symbol">=</span> cnt <span class="sh_symbol">=</span> P<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_function">memset</span><span class="sh_symbol">(</span>first<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> first<span class="sh_symbol">);</span>
        <span class="sh_function">memset</span><span class="sh_symbol">(</span>next<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> next<span class="sh_symbol">);</span>
        <span class="sh_function">memset</span><span class="sh_symbol">(</span>P<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> P<span class="sh_symbol">);</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">2</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
            <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> P<span class="sh_symbol">[</span>i<span class="sh_symbol">]);</span>
            <span class="sh_function">addedge</span><span class="sh_symbol">(</span>P<span class="sh_symbol">[</span>i<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">],</span> i<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
        dep<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">);</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
            cs<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span><span class="sh_function">clear</span><span class="sh_symbol">();</span> adod<span class="sh_symbol">[</span>i <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> i<span class="sh_symbol">;</span>
        <span class="sh_cbracket">}</span>
        <span class="sh_function">sort</span><span class="sh_symbol">(</span>adod<span class="sh_symbol">,</span> adod <span class="sh_symbol">+</span> n<span class="sh_symbol">,</span> cmp<span class="sh_symbol">);</span>
        st<span class="sh_symbol">.</span><span class="sh_function">resize</span><span class="sh_symbol">(</span>n<span class="sh_symbol">,</span> n<span class="sh_symbol">);</span> st<span class="sh_symbol">.</span><span class="sh_function">init</span><span class="sh_symbol">();</span>
        depth <span class="sh_symbol">=</span> dep<span class="sh_symbol">[</span>adod<span class="sh_symbol">[</span>n <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">]];</span>
        dep<span class="sh_symbol">[</span>adod<span class="sh_symbol">[</span>n<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> n <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> INT_MAX<span class="sh_symbol">;</span> <span class="sh_comment">// auxiliary</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
            x <span class="sh_symbol">=</span> adod<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span>
            col <span class="sh_symbol">=</span> c<span class="sh_symbol">[</span>x<span class="sh_symbol">];</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>cs<span class="sh_symbol">[</span>col<span class="sh_symbol">].</span><span class="sh_function">empty</span><span class="sh_symbol">())</span> d <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
            <span class="sh_keyword">else</span><span class="sh_cbracket">{</span>
                jt <span class="sh_symbol">=</span> cs<span class="sh_symbol">[</span>col<span class="sh_symbol">].</span><span class="sh_function">lower_bound</span><span class="sh_symbol">(</span>lr_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">]);</span>
                <span class="sh_symbol">(</span>it <span class="sh_symbol">=</span> jt<span class="sh_symbol">)</span> <span class="sh_symbol">==</span> cs<span class="sh_symbol">[</span>col<span class="sh_symbol">].</span><span class="sh_function">begin</span><span class="sh_symbol">()</span> <span class="sh_symbol">?</span> it <span class="sh_symbol">:</span> <span class="sh_symbol">--</span>it<span class="sh_symbol">;</span>
                lci <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>it <span class="sh_symbol">==</span> cs<span class="sh_symbol">[</span>col<span class="sh_symbol">].</span><span class="sh_function">end</span><span class="sh_symbol">()</span> <span class="sh_symbol">?</span> <span class="sh_number">0</span> <span class="sh_symbol">:</span> <span class="sh_function">LCA</span><span class="sh_symbol">(</span>id<span class="sh_symbol">[*</span>it<span class="sh_symbol">],</span> x<span class="sh_symbol">));</span>
                lcj <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>jt <span class="sh_symbol">==</span> cs<span class="sh_symbol">[</span>col<span class="sh_symbol">].</span><span class="sh_function">end</span><span class="sh_symbol">()</span> <span class="sh_symbol">?</span> <span class="sh_number">0</span> <span class="sh_symbol">:</span> <span class="sh_function">LCA</span><span class="sh_symbol">(</span>id<span class="sh_symbol">[*</span>jt<span class="sh_symbol">],</span> x<span class="sh_symbol">));</span>
                d <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>dep<span class="sh_symbol">[</span>lci<span class="sh_symbol">]</span> <span class="sh_symbol">&gt;=</span> dep<span class="sh_symbol">[</span>lcj<span class="sh_symbol">]</span> <span class="sh_symbol">?</span> lci <span class="sh_symbol">:</span> lcj<span class="sh_symbol">);</span>
            <span class="sh_cbracket">}</span>
            cs<span class="sh_symbol">[</span>col<span class="sh_symbol">].</span><span class="sh_function">insert</span><span class="sh_symbol">(</span>lr_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">]);</span>
            st<span class="sh_symbol">.</span><span class="sh_function">add</span><span class="sh_symbol">(</span>lr_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">],</span> <span class="sh_number">1</span><span class="sh_symbol">);</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>d<span class="sh_symbol">)</span> st<span class="sh_symbol">.</span><span class="sh_function">add</span><span class="sh_symbol">(</span>lr_bd<span class="sh_symbol">[</span>d<span class="sh_symbol">],</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">);</span>
            <span class="sh_comment">// last one of current depth</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> dep<span class="sh_symbol">[</span>adod<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">]])</span>
                stime<span class="sh_symbol">[</span>dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]]</span> <span class="sh_symbol">=</span> st<span class="sh_symbol">.</span>tim<span class="sh_symbol">;</span>
        <span class="sh_cbracket">}</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>ans <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> q<span class="sh_symbol">;</span> q<span class="sh_symbol">--)</span><span class="sh_cbracket">{</span>
            <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>d<span class="sh_symbol">);</span>
            x <span class="sh_symbol">^=</span> ans<span class="sh_symbol">;</span> d <span class="sh_symbol">^=</span> ans<span class="sh_symbol">;</span>
            d <span class="sh_symbol">=</span> <span class="sh_function">min</span><span class="sh_symbol">(</span>depth<span class="sh_symbol">,</span> dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">+</span> d<span class="sh_symbol">);</span>
            ans <span class="sh_symbol">=</span> st<span class="sh_symbol">.</span><span class="sh_function">range</span><span class="sh_symbol">(</span>lr_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">],</span> up_bd<span class="sh_symbol">[</span>x<span class="sh_symbol">],</span> stime<span class="sh_symbol">[</span>d<span class="sh_symbol">]);</span>
            <span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"%d</span><span class="sh_specialchar">\n</span><span class="sh_string">"</span><span class="sh_symbol">,</span> ans<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h2>坑</h2>
<p><s>这题的坑又创历史新高了……</s></p>
<p><b>坑1：</b>由于可持久化线段树的内存是 <img src="http://latex.codecogs.com/gif.latex?\Theta(n\log^2n)"> 的，因此开内存的时候一定要大方一点，不要开很小，像这次就开到 <code>cnt = 48n, time = 24n</code>。<s>(然而内存连 128 MB 都不到？)</s></p>
<p><b>坑2：</b>根据经验，"强制在线的题目 RE 就是 WA"，就开始想怎么 WA。首先，可持久化线段树，LCA 等版子基本不会出问题，所以就去搞那长长的 <code>main()</code> 函数，一开始发现 set 的 begin 和 end 没有判，导致访问了非法内存 (原来就是 RE)。</p>
<p>然后还是 RE，但这回不是非法内存，而是爆栈。无奈之下开始 clap。结果 clap 从 <i>n</i> = 4 到 <i>n</i> = 10<sup>5</sup> 都没问题，就开始<s>斯波地怀疑 HDU 的栈空间有多小……</s>(因为极限数据一条链的话，栈也就 10<sup>5</sup> 层这个样子，1 个 MB 都不到)。</p>
<p>最后才发现，我所有的 clap 数据全是 <i>T</i> = 1 的情况，<s>想当然以为 <i>T</i> &gt; 1 是稳的</s>。然后去尝试以下一组 <i>T</i> = 2 的数据，结果 clap 3 次下来直接就挂了……</p>
<p>(scx: 那么到底是什么原因呢？)</p>
<p>结果又调了 20 min 发现，这个罪魁祸首竟然是……邻接表和倍增 LCA 数组没有清 0，已经彻底无语。(scx: ...)</p>
