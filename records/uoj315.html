<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">
<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]}});</script>
<script type="text/javascript" src="../additional_files/MathJax-master/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<h3>题目描述</h3>
<p>蚯蚓幼儿园有 $n$ 只蚯蚓。<del>幼儿园园长</del> scx 为了管理方便，时常让这些蚯蚓们列队表演。</p>
<p>所有蚯蚓用从 $1$ 到 $n$ 的连续正整数编号。每只蚯蚓的长度可以用一个 $1 \sim 6$ 的正整数表示，scx 希望这些蚯蚓排成若干个队伍，初始时，每只蚯蚓各自排成一个仅有一只蚯蚓的队伍，该蚯蚓既在队首，也在队尾。</p>
<p>scx 将会依次进行 $m$ 次操作，每个操作都是以下三种操作中的一种：</p>
<ol>
<li>给出 $i$ 和 $j$，令 $i$ 号蚯蚓与 $j$ 号蚯蚓所在的两个队伍合并为一个队伍，具体来说，令 $j$ 号蚯蚓紧挨在 $i$ 号蚯蚓之后，其余蚯蚓保持队伍的前后关系不变。</li>
<li>给出 $i$，令 $i$ 号蚯蚓与紧挨其后的一只蚯蚓分离为两个队伍，具体来说，在分离之后，$i$ 号蚯蚓在其中一个队伍的队尾，原本紧挨其后的那一只蚯蚓在另一个队伍的队首，其余蚯蚓保持队伍的前后关系不变。</li>
<li>给出一个正整数 $k$ 和一个长度至少为 $k$ 的数字串 $s$，对于 $s$ 的 $|s| - k + 1$ 个长度为 $k$ 的连续子串 $t$，定义函数 $f(t)$，询问所有这些 $f(t)$ 的<strong>乘积</strong>对 $998244353$ ($7 \times 17 \times 2^{23} + 1$，一个质数) 取模后的结果。其中 $f(t)$ 的定义见下文。</li>
</ol>
<p>对于当前的蚯蚓队伍，定义某个蚯蚓的<strong>向后 $k$ 数字串</strong>为：</p>
<p>从该蚯蚓出发，沿队伍的向后方向，寻找最近的 $k$ 只蚯蚓 (包括其自身)，将这些蚯蚓的<strong>长度</strong>视作字符连接而成的数字串；如果这样找到的蚯蚓不足 $k$ 只，则其没有<strong>向后 $k$ 数字串</strong>。</p>
<p>例如蚯蚓的队伍为 $10$ 号蚯蚓在队首，其后是 $22$ 号蚯蚓，其后是 $3$ 号蚯蚓 (为队尾)，这些蚯蚓的长度分别为 $4, 5, 6$，则 $10$ 号蚯蚓的<strong>向后 $3$ 数字串</strong>为 <code>456</code>；</p>
<p>$22$ 号蚯蚓没有<strong>向后 $3$ 数字串</strong>，但其<strong>向后 $2$ 数字串</strong>为 <code>56</code>，其<strong>向后 $1$ 数字串</strong>为 <code>5</code>。</p>
<p>$f(t)$ 表示所有蚯蚓中，<strong>向后 $k$ 数字串</strong>恰好为 $t$ 的蚯蚓只数。</p>

<h3>输入格式</h3>
<p>第一行包含两个正整数 $n, m$ ($1 \leq n \leq 2 \times 10^5, 1 \leq m \leq 3 \times 10^5$)，分别表示蚯蚓的只数与操作次数。</p>
<p>第二行包含 $n$ 个不超过 $6$ 的正整数，依次表示编号为 $1, 2, \cdots, n$ 的蚯蚓的长度。</p>
<p>接下来 $m$ 行，每行表示一个操作。每个操作的格式可以为：</p>
<ol>
<li><code>1 i j</code> ($1 \leq i, j \leq n$) 表示：令 $i$ 号与 $j$ 号蚯蚓<strong>所在</strong>的两个队伍合并为一个队伍，新队伍中，$j$ 号蚯蚓紧挨在 $i$ 号蚯蚓之后。保证在此操作之前，$i$ 号蚯蚓在某个队伍的队尾，$j$ 号蚯蚓在某个队伍的队首，且两只蚯蚓不在同一个队伍中。</li>
<li><code>2 i</code> ($1 \leq i \leq n$) 表示：令 $i$ 号蚯蚓与紧挨其后一个蚯蚓分离为两个队伍。保证在此操作之前，$i$ 号蚯蚓不是某个队伍的队尾。</li>
<li><code>3 s k</code>($1 \leq k \leq \min(50, |s|), \sum|s| \leq 10^7$) 表示：询问 $s$ 的每个长度为 $k$ 的子串 $t$ 的 $f(t)$ 的乘积，对 $998244353$ 取模的结果。$f(t)$ 的定义见题目描述。</li>
</ol>
<p>同一行输入的相邻两个元素之间，用恰好一个空格隔开。</p>
<p>输入可能较大，请不要使用过于缓慢的读入方式。</p>

<h3>输出格式</h3>
<p>依次对于每个形如 <code>3 s k</code> 的操作，输出一行，仅包含一个整数，表示询问的结果。</p>

<h3>题解</h3>
<p>注意到 $k \leq 50$ 这个条件，可以发现，只需要存储长度不超过 $50$ 的子串。</p>
<p>考虑使(shou)用(xie) <code>hash_map</code>，记录每种 (长度不超过 $k$ 的) 子串的出现次数。</p>
<p>考虑对 $n$ 只蚯蚓使用链表存储。</p>
<p>每一次合并 (分裂)，可以看出至多增加 (减少) $O(k^2)$ 个新的字符串，因此可以直接枚举 $i$ 所在的链表尾和 $j$ 所在的链表头将增加的<strong>长度不超过 $k$ 的</strong>字符串放入 <code>hash_map</code> 中。</p>
<p>其实这两个操作可以统一放入一个函数 <code>modify(x, y, op)</code> 中，用 <code>op</code> 控制合并 (增加字符串) 还是分裂 (减少字符串)。</p>
<p>最后统计的时候，枚举 $s$ 的所有长度为 $k$ 的子串，分别在 <code>hash_map</code> 中查值对应相乘即可，<del>算法难度其实也不是很大</del>。</p>

<h3>代码</h3>

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> N <span class="sh_number">512202</span>
<span class="sh_preproc">#define</span> S <span class="sh_number">10073306</span>
<span class="sh_preproc">#define</span> K <span class="sh_number">50</span>
<span class="sh_preproc">#define</span> <span class="sh_usertype">ID</span><span class="sh_normal"> </span><span class="sh_function">isdigit</span><span class="sh_symbol">(</span>c <span class="sh_symbol">=</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">++)</span>
<span class="sh_preproc">#define</span> <span class="sh_usertype">RT</span><span class="sh_normal"> </span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>c <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_keyword">return</span> flag <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span>
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">Istream</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> flag<span class="sh_symbol">;</span> <span class="sh_type">char</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">,</span> buf<span class="sh_symbol">[</span><span class="sh_number">80000000</span><span class="sh_symbol">];</span>
    <span class="sh_type">void</span> <span class="sh_function">init</span><span class="sh_symbol">(</span><span class="sh_usertype">FILE</span><span class="sh_normal"> </span><span class="sh_symbol">*</span>f <span class="sh_symbol">=</span> stdin<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">fread</span><span class="sh_symbol">(</span>buf<span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> buf<span class="sh_symbol">,</span> f<span class="sh_symbol">);</span> next <span class="sh_symbol">=</span> buf<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    Istream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_type">int</span> c<span class="sh_symbol">,</span> l <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(;</span> <span class="sh_symbol">!</span>ID<span class="sh_symbol">;</span> l <span class="sh_symbol">=</span> c<span class="sh_symbol">)</span> RT<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>x <span class="sh_symbol">=</span> c <span class="sh_symbol">-</span> <span class="sh_number">48</span><span class="sh_symbol">;</span> ID<span class="sh_symbol">;</span> x <span class="sh_symbol">=</span> x <span class="sh_symbol">*</span> <span class="sh_number">10</span> <span class="sh_symbol">+</span> <span class="sh_symbol">(</span>c <span class="sh_symbol">-</span> <span class="sh_number">48</span><span class="sh_symbol">))</span> RT<span class="sh_symbol">;</span> RT<span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>l <span class="sh_symbol">==</span> <span class="sh_number">45</span><span class="sh_symbol">)</span> x <span class="sh_symbol">=</span> <span class="sh_symbol">-</span>x<span class="sh_symbol">;</span>
        <span class="sh_keyword">return</span> flag <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    Istream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_symbol">(</span><span class="sh_type">char</span> <span class="sh_symbol">*</span>x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_type">int</span> c<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(;</span> <span class="sh_symbol">(</span>c <span class="sh_symbol">=</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">++)</span> <span class="sh_symbol">&lt;=</span> <span class="sh_string">' '</span><span class="sh_symbol">;</span> <span class="sh_symbol">)</span> RT<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(*</span>x<span class="sh_symbol">++</span> <span class="sh_symbol">=</span> c<span class="sh_symbol">;</span> <span class="sh_symbol">(</span>c <span class="sh_symbol">=</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">++)</span> <span class="sh_symbol">&gt;</span> <span class="sh_string">' '</span><span class="sh_symbol">;</span> <span class="sh_symbol">*</span>x<span class="sh_symbol">++</span> <span class="sh_symbol">=</span> c<span class="sh_symbol">)</span> RT<span class="sh_symbol">;</span> RT<span class="sh_symbol">;</span>
        <span class="sh_symbol">*</span>x <span class="sh_symbol">=</span> <span class="sh_string">'</span><span class="sh_specialchar">\0</span><span class="sh_string">'</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">return</span> flag <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">char</span> <span class="sh_function">get</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">++;</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">operator</span> <span class="sh_type">void</span> <span class="sh_symbol">*()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> flag <span class="sh_symbol">?</span> <span class="sh_keyword">this</span> <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>Cin<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">Ostream</span><span class="sh_cbracket">{</span>
    FILE <span class="sh_symbol">*</span>_f<span class="sh_symbol">;</span> <span class="sh_type">char</span> buf<span class="sh_symbol">[</span><span class="sh_number">34</span><span class="sh_symbol">];</span>
    <span class="sh_type">void</span> <span class="sh_function">init</span><span class="sh_symbol">(</span><span class="sh_usertype">FILE</span><span class="sh_normal"> </span><span class="sh_symbol">*</span>f <span class="sh_symbol">=</span> stdout<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>_f <span class="sh_symbol">=</span> f<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    Ostream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">long</span> <span class="sh_type">long</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(!</span>x<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> <span class="sh_function">put</span><span class="sh_symbol">(</span><span class="sh_number">48</span><span class="sh_symbol">),</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>x <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">put</span><span class="sh_symbol">(</span><span class="sh_number">45</span><span class="sh_symbol">);</span> x <span class="sh_symbol">=</span> <span class="sh_symbol">-</span>x<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
        <span class="sh_type">int</span> i<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x <span class="sh_symbol">&gt;</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x <span class="sh_symbol">/=</span> <span class="sh_number">10</span><span class="sh_symbol">)</span> buf<span class="sh_symbol">[</span>i<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> x <span class="sh_symbol">%</span> <span class="sh_number">10</span> <span class="sh_symbol">+</span> <span class="sh_number">48</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">while</span><span class="sh_symbol">(--</span>i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_function">put</span><span class="sh_symbol">(</span>buf<span class="sh_symbol">[</span>i<span class="sh_symbol">]);</span>
        <span class="sh_keyword">return</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    Ostream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">char</span> c<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_function">put</span><span class="sh_symbol">(</span>c<span class="sh_symbol">),</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">put</span><span class="sh_symbol">(</span><span class="sh_type">char</span> c<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">fputc</span><span class="sh_symbol">(</span>c<span class="sh_symbol">,</span> _f<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>Cout<span class="sh_symbol">;</span>

<span class="sh_keyword">typedef</span> <span class="sh_type">long</span> <span class="sh_type">long</span> ll<span class="sh_symbol">;</span>
<span class="sh_keyword">const</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span>MOD <span class="sh_symbol">=</span> <span class="sh_number">998244353</span><span class="sh_symbol">,</span> HASH_MAX <span class="sh_symbol">=</span> <span class="sh_number">16777215</span><span class="sh_symbol">;</span>
<span class="sh_keyword">const</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span>mod0 <span class="sh_symbol">=</span> <span class="sh_number">998244353</span><span class="sh_symbol">,</span> mod1 <span class="sh_symbol">=</span> <span class="sh_number">1000000007</span><span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">data</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> h1<span class="sh_symbol">,</span> h2<span class="sh_symbol">;</span>
    <span class="sh_function">data</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> Hash <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">):</span> <span class="sh_function">h1</span><span class="sh_symbol">(</span>Hash<span class="sh_symbol">),</span> <span class="sh_function">h2</span><span class="sh_symbol">(</span>Hash<span class="sh_symbol">)</span> <span class="sh_cbracket">{}</span>
    <span class="sh_function">data</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> H1<span class="sh_symbol">,</span> <span class="sh_type">int</span> H2<span class="sh_symbol">):</span> <span class="sh_function">h1</span><span class="sh_symbol">(</span>H1<span class="sh_symbol">),</span> <span class="sh_function">h2</span><span class="sh_symbol">(</span>H2<span class="sh_symbol">)</span> <span class="sh_cbracket">{}</span>
    <span class="sh_type">bool</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">==</span> <span class="sh_symbol">(</span><span class="sh_keyword">const</span> <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>b<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> h1 <span class="sh_symbol">==</span> b<span class="sh_symbol">.</span>h1 <span class="sh_symbol">&amp;&amp;</span> h2 <span class="sh_symbol">==</span> b<span class="sh_symbol">.</span>h2<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_keyword">operator</span> <span class="sh_symbol">+</span> <span class="sh_symbol">(</span><span class="sh_keyword">const</span> <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>b<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_function">data</span><span class="sh_symbol">((</span>h1 <span class="sh_symbol">+</span> b<span class="sh_symbol">.</span>h1<span class="sh_symbol">)</span> <span class="sh_symbol">%</span> mod0<span class="sh_symbol">,</span> <span class="sh_symbol">(</span>h2 <span class="sh_symbol">+</span> b<span class="sh_symbol">.</span>h2<span class="sh_symbol">)</span> <span class="sh_symbol">%</span> mod1<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_keyword">operator</span> <span class="sh_symbol">-</span> <span class="sh_symbol">(</span><span class="sh_keyword">const</span> <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>b<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_function">data</span><span class="sh_symbol">((</span>h1 <span class="sh_symbol">-</span> b<span class="sh_symbol">.</span>h1 <span class="sh_symbol">+</span> mod0<span class="sh_symbol">)</span> <span class="sh_symbol">%</span> mod0<span class="sh_symbol">,</span> <span class="sh_symbol">(</span>h2 <span class="sh_symbol">-</span> b<span class="sh_symbol">.</span>h2 <span class="sh_symbol">+</span> mod1<span class="sh_symbol">)</span> <span class="sh_symbol">%</span> mod1<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> b<span class="sh_symbol">);</span>
    <span class="sh_keyword">inline</span> <span class="sh_type">int</span> <span class="sh_function">getHash</span><span class="sh_symbol">()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_symbol">((</span>ll<span class="sh_symbol">)</span>h1 <span class="sh_symbol">*</span> <span class="sh_number">85367</span> <span class="sh_symbol">+</span> h2<span class="sh_symbol">)</span> <span class="sh_symbol">&amp;</span> HASH_MAX<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>
<span class="sh_usertype">data</span><span class="sh_normal"> </span>pw<span class="sh_symbol">[</span><span class="sh_number">57</span><span class="sh_symbol">];</span>

<span class="sh_usertype">data</span><span class="sh_normal"> </span>data<span class="sh_symbol">::</span><span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> b<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_function">data</span><span class="sh_symbol">((</span>ll<span class="sh_symbol">)</span>h1 <span class="sh_symbol">*</span> pw<span class="sh_symbol">[</span>b<span class="sh_symbol">].</span>h1 <span class="sh_symbol">%</span> mod0<span class="sh_symbol">,</span> <span class="sh_symbol">(</span>ll<span class="sh_symbol">)</span>h2 <span class="sh_symbol">*</span> pw<span class="sh_symbol">[</span>b<span class="sh_symbol">].</span>h2 <span class="sh_symbol">%</span> mod1<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">int</span> cnt<span class="sh_symbol">,</span> first<span class="sh_symbol">[</span>HASH_MAX <span class="sh_symbol">+</span> <span class="sh_number">2</span><span class="sh_symbol">],</span> nxt<span class="sh_symbol">[</span>HASH_MAX <span class="sh_symbol">+</span> <span class="sh_number">2</span><span class="sh_symbol">],</span> val<span class="sh_symbol">[</span>HASH_MAX <span class="sh_symbol">+</span> <span class="sh_number">2</span><span class="sh_symbol">];</span> <span class="sh_usertype">data</span><span class="sh_normal"> </span>z<span class="sh_symbol">[</span>HASH_MAX <span class="sh_symbol">+</span> <span class="sh_number">2</span><span class="sh_symbol">];</span>

<span class="sh_type">void</span> <span class="sh_function">add</span><span class="sh_symbol">(</span><span class="sh_usertype">data</span><span class="sh_normal"> </span>h<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> x <span class="sh_symbol">=</span> h<span class="sh_symbol">.</span><span class="sh_function">getHash</span><span class="sh_symbol">(),</span> i<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>x<span class="sh_symbol">];</span> i<span class="sh_symbol">;</span> i <span class="sh_symbol">=</span> nxt<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span>z<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">==</span> h<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> val<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">+=</span> v<span class="sh_symbol">,</span> <span class="sh_type">void</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">);</span>
    z<span class="sh_symbol">[++</span>cnt<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> h<span class="sh_symbol">;</span> val<span class="sh_symbol">[</span>cnt<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> v<span class="sh_symbol">;</span> nxt<span class="sh_symbol">[</span>cnt<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>x<span class="sh_symbol">];</span> first<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cnt<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">count</span><span class="sh_symbol">(</span><span class="sh_usertype">data</span><span class="sh_normal"> </span>h<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> x <span class="sh_symbol">=</span> h<span class="sh_symbol">.</span><span class="sh_function">getHash</span><span class="sh_symbol">(),</span> i<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> first<span class="sh_symbol">[</span>x<span class="sh_symbol">];</span> i<span class="sh_symbol">;</span> i <span class="sh_symbol">=</span> nxt<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span>z<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">==</span> h<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> val<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span>
    <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> n<span class="sh_symbol">,</span> q<span class="sh_symbol">,</span> c<span class="sh_symbol">;</span>
<span class="sh_type">int</span> a<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> next<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> last<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_type">int</span> stk1<span class="sh_symbol">[</span><span class="sh_number">57</span><span class="sh_symbol">],</span> stk2<span class="sh_symbol">[</span><span class="sh_number">57</span><span class="sh_symbol">],</span> cnt1<span class="sh_symbol">,</span> cnt2<span class="sh_symbol">;</span>
<span class="sh_type">char</span> s<span class="sh_symbol">[</span>S<span class="sh_symbol">];</span>
<span class="sh_usertype">data</span><span class="sh_normal"> </span>ha<span class="sh_symbol">[</span>S<span class="sh_symbol">];</span>

<span class="sh_type">void</span> <span class="sh_function">modify</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">,</span> <span class="sh_type">int</span> op<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span> <span class="sh_usertype">data</span><span class="sh_normal"> </span><span class="sh_function">d</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">),</span> t<span class="sh_symbol">;</span>
    cnt1 <span class="sh_symbol">=</span> cnt2 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> x<span class="sh_symbol">;</span> i <span class="sh_symbol">&amp;&amp;</span> cnt1 <span class="sh_symbol">&lt;</span> K<span class="sh_symbol">;</span> i <span class="sh_symbol">=</span> last<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span> stk1<span class="sh_symbol">[</span>cnt1<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> a<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>j <span class="sh_symbol">=</span> y<span class="sh_symbol">;</span> j <span class="sh_symbol">&amp;&amp;</span> cnt2 <span class="sh_symbol">&lt;</span> K<span class="sh_symbol">;</span> j <span class="sh_symbol">=</span> next<span class="sh_symbol">[</span>j<span class="sh_symbol">])</span> stk2<span class="sh_symbol">[</span>cnt2<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> a<span class="sh_symbol">[</span>j<span class="sh_symbol">];</span>
    stk1<span class="sh_symbol">[</span>cnt1<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> cnt1 <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> <span class="sh_symbol">~</span>i<span class="sh_symbol">;</span> <span class="sh_symbol">--</span>i<span class="sh_symbol">)</span> d <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>d <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_function">data</span><span class="sh_symbol">(</span>stk1<span class="sh_symbol">[</span>i<span class="sh_symbol">]);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> cnt1<span class="sh_symbol">;</span> i<span class="sh_symbol">;</span> <span class="sh_symbol">--</span>i<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        t <span class="sh_symbol">=</span> d <span class="sh_symbol">-</span> <span class="sh_symbol">(</span><span class="sh_function">data</span><span class="sh_symbol">(</span>stk1<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span> <span class="sh_symbol">&lt;&lt;</span> i<span class="sh_symbol">);</span> d <span class="sh_symbol">=</span> t<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>j <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> j <span class="sh_symbol">&lt;</span> cnt2 <span class="sh_symbol">&amp;&amp;</span> i <span class="sh_symbol">+</span> j <span class="sh_symbol">&lt;=</span> K<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>j<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
            t <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>t <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_function">data</span><span class="sh_symbol">(</span>stk2<span class="sh_symbol">[</span>j<span class="sh_symbol">]);</span>
            <span class="sh_function">add</span><span class="sh_symbol">(</span>t<span class="sh_symbol">,</span> op<span class="sh_symbol">);</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">solve</span><span class="sh_symbol">(</span><span class="sh_type">int</span> k<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> len <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span>ans <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_type">char</span> <span class="sh_symbol">*</span>p <span class="sh_symbol">=</span> s<span class="sh_symbol">;</span> <span class="sh_symbol">*</span>p<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>p<span class="sh_symbol">,</span> <span class="sh_symbol">++</span>len<span class="sh_symbol">)</span> ha<span class="sh_symbol">[</span>len <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>ha<span class="sh_symbol">[</span>len<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_function">data</span><span class="sh_symbol">(*</span>p <span class="sh_symbol">&amp;=</span> <span class="sh_number">15</span><span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">+</span> k <span class="sh_symbol">&lt;=</span> len<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        j <span class="sh_symbol">=</span> <span class="sh_function">count</span><span class="sh_symbol">(</span>ha<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> k<span class="sh_symbol">]</span> <span class="sh_symbol">-</span> <span class="sh_symbol">(</span>ha<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;&lt;</span> k<span class="sh_symbol">));</span>
        <span class="sh_symbol">(</span>ans <span class="sh_symbol">*=</span> j<span class="sh_symbol">)</span> <span class="sh_symbol">%=</span> MOD<span class="sh_symbol">;</span> <span class="sh_keyword">if</span><span class="sh_symbol">(!</span>ans<span class="sh_symbol">)</span> <span class="sh_keyword">break</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    Cout <span class="sh_symbol">&lt;&lt;</span> ans <span class="sh_symbol">&lt;&lt;</span> <span class="sh_string">'</span><span class="sh_specialchar">\n</span><span class="sh_string">'</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span>
    pw<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">data</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">57</span><span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> pw<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">data</span><span class="sh_symbol">((</span>ll<span class="sh_symbol">)</span>pw<span class="sh_symbol">[</span>i <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">].</span>h1 <span class="sh_symbol">*</span> <span class="sh_number">4621</span> <span class="sh_symbol">%</span> mod0<span class="sh_symbol">,</span> <span class="sh_symbol">(</span>ll<span class="sh_symbol">)</span>pw<span class="sh_symbol">[</span>i <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">].</span>h2 <span class="sh_symbol">*</span> <span class="sh_number">6577</span> <span class="sh_symbol">%</span> mod1<span class="sh_symbol">);</span>
    Cin<span class="sh_symbol">.</span><span class="sh_function">init</span><span class="sh_symbol">();</span> Cout<span class="sh_symbol">.</span><span class="sh_function">init</span><span class="sh_symbol">();</span> Cin <span class="sh_symbol">&gt;&gt;</span> n <span class="sh_symbol">&gt;&gt;</span> q<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>Cin <span class="sh_symbol">&gt;&gt;</span> a<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span> <span class="sh_function">add</span><span class="sh_symbol">(</span><span class="sh_function">data</span><span class="sh_symbol">(</span>a<span class="sh_symbol">[</span>i<span class="sh_symbol">]),</span> <span class="sh_number">1</span><span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(;</span> q<span class="sh_symbol">;</span> <span class="sh_symbol">--</span>q<span class="sh_symbol">)</span>
        <span class="sh_keyword">switch</span><span class="sh_symbol">(</span>Cin <span class="sh_symbol">&gt;&gt;</span> c<span class="sh_symbol">,</span> c<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
            <span class="sh_keyword">case</span> <span class="sh_number">1</span><span class="sh_symbol">:</span>
                Cin <span class="sh_symbol">&gt;&gt;</span> i <span class="sh_symbol">&gt;&gt;</span> j<span class="sh_symbol">;</span>
                next<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> j<span class="sh_symbol">;</span> last<span class="sh_symbol">[</span>j<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> i<span class="sh_symbol">;</span>
                <span class="sh_function">modify</span><span class="sh_symbol">(</span>i<span class="sh_symbol">,</span> j<span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">);</span>
                <span class="sh_keyword">break</span><span class="sh_symbol">;</span>
            <span class="sh_keyword">case</span> <span class="sh_number">2</span><span class="sh_symbol">:</span>
                Cin <span class="sh_symbol">&gt;&gt;</span> i<span class="sh_symbol">;</span> j <span class="sh_symbol">=</span> next<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span>
                next<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> last<span class="sh_symbol">[</span>j<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
                <span class="sh_function">modify</span><span class="sh_symbol">(</span>i<span class="sh_symbol">,</span> j<span class="sh_symbol">,</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">);</span>
                <span class="sh_keyword">break</span><span class="sh_symbol">;</span>
            <span class="sh_keyword">case</span> <span class="sh_number">3</span><span class="sh_symbol">:</span>
                Cin <span class="sh_symbol">&gt;&gt;</span> s <span class="sh_symbol">&gt;&gt;</span> i<span class="sh_symbol">;</span>
                <span class="sh_function">solve</span><span class="sh_symbol">(</span>i<span class="sh_symbol">);</span>
                <span class="sh_keyword">break</span><span class="sh_symbol">;</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h3>坑</h3>
<p><strong>坑1：</strong>由于长度不超过 $k$ 的子串个数有 $\Theta(6^k)$ 个，最坏情况下约有 $9.7 \times 10^{38}$ 个，<del>因此需要 $17$ 个字节来存储</del>，所以要考虑写一个双 Hash (<strong>单 Hash 很有可能被卡 WA，三 Hash 要 TLE</strong>) 来代表这个字符串 (尽量使用经典的可逆的<strong>多项式 Hash</strong>)，<strong>再放进 <code>hash_map</code> 中</strong>。</p>
<p>另外模数要选好，尽量选择形如 $2^n - 1$ 的梅森数，可以用 <code>&amp;</code> 运算，从而避免大量的 <code>%</code> 运算。</p>
<p><strong>坑2：</strong>这道题都说过要 IO 优化了，所以肯定要写的，而且这道题的卡常还是非常厉害的，尽量不要用 <code>class</code> 或 <code>struct</code>，可以用 <code>namespace</code> <strong>或者干脆直接拿出来</strong>，减少不必要的常数。</p>
