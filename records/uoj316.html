<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">
<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]}});</script>
<script type="text/javascript" src="../additional_files/MathJax-master/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<h3>题目描述</h3>
<p><del>scx 是个爱玩的女孩子。</del></p>
<p>暑假终于到了，scx 决定请她的朋友们来游泳，她打算先在她家的私人海滩外圈一块长方形的海域作为游泳场。然而大海里有着各种各样的危险，有些地方水太深，有些地方有带毒的水母出没。她想让圈出来的这一块海域都是安全的。</p>
<p>经过初步的分析，她把这块海域抽象成了一个底边长为 $N$ 米，高为 $1001$ 米的长方形网格。其中网格的底边对应着她家的私人海滩，每一个 $1 \mathrm{m} \times 1 \mathrm{m}$ 的小正方形都代表着一个单位海域。她拜托了她爸爸明天去测量每一个小正方形是否安全。在得知了信息之后，她要做的就是圈出她想要的游泳场啦。</p>
<p>她心目中理想的游泳场满足如下三个条件：</p>
<ol>
<li>必须保证安全性。即游泳场中的每一个单位海域都是安全的。</li>
<li>必须是矩形。即游泳场必须是整个网格中的一个 $a \times b$ 的子网格。</li>
<li>必须和海滩相邻。即游泳场的下边界必须紧贴网格的下边界。</li>
</ol>
<p>例如：当 $N = 5$ 时，若测量的结果如下 (因为 $1001$ 太大，这儿只画出网格最下面三行的信息，<strong>其他部分都是危险的</strong>)。</p>
<p><img src="http://img.uoj.ac/problem/316/1.png" style="width: 400px" /></p>
<p>那么她可以选取最下面一行的 $1 \times 4$ 的子海域，也可以选择第三列的 $3 \times 1$ 的子海域。注意她不能选取最上面一行的 $1 \times 5$ 的子海域，因为它没有与海滩相邻。</p>
<p>为了让朋友们玩的开心，她想让游泳场的面积尽可能的大。因此她会选取最下面那一行的 $1 \times 4$ 的子海域作为最终方案。</p>
<p>虽然她要明天才能知道每一个单位海域是否安全，但是她现在就想行动起来估计一下她的游泳场面积有多大。经过简单的估计，她假设每一个单位海域都有独立的 $q$ 的概率是安全的，$1 - q$ 的概率是不安全的。她想要知道她能选择的最大的游泳场的面积<strong>恰好</strong>为 $K$ 的概率是多少。</p>
<p>然而 scx 对数学并不感兴趣，因此她想让你来帮她计算一下这个数值。</p>

<h3>输入格式</h3>
<p>输入共一行，包含四个正整数 $N, K, x, y$ ($N \leq 10^9, K \leq 1000, x &lt; y &lt; 998244353$)。$q$ 的取值为 $\dfrac xy$。</p>

<h3>输出格式</h3>
<p>输出一行，包含一个整数表示答案在模 $998244353$ 意义下的取值。</p>

<h3>题解</h3>
<p>又是一道超神概率 DP 题……</p>
<p>先声明一些记号，和原题一样，$a \times b$ 的网格代表 <strong>$a$ 行 $b$ 列</strong>的网格，一个格子安全的概率<strong>记为 $p$ (就是原题中的 $q$)</strong>，危险的概率为 $q = 1 - p$。</p>
<p>还有恰好为 $K$ 不好计算，但是计算 $\leq K$ 的概率还是比较方便的，因此利用<strong>整数的离散型</strong>，用 $\leq K$ 的减去 $\leq K-1$ 的即得答案。</p>
<p>记 $f_{i, j}$ 表示<strong>共 $j$ 列</strong>，且在<strong>已知这 $j$ 列中，最靠近海滩的 $i$ 行，即最靠近海滩的 $i \times j$ 的网格中都安全的条件</strong>下，最大游泳场的面积<strong>不超过 $K$ 的条件</strong>概率，由定义，当 $i \cdot j &gt; K$ 时，$f_{i, j} = 0$。</p>
<p>考虑求 $f_{i, 1}$ ($0 \leq i \leq K$)。由全概率公式，$i \times 1$ 的网格已知安全的那个条件概率，等于它上面一格危险的概率，加上上面一格安全的概率乘上 $f_{i + 1, 1}$，即</p>
<p>$$ f_{i, 1} = pf_{i + 1, 1} + q $$</p>
<p>(其实 $f_{i, 1} = 1 - p^{K - i + 1}$，不过这并不重要)，然后考虑 $f_{i, j}$ ($0 \leq i \leq \left\lfloor \dfrac kj \right\rfloor$)，考虑它再上面一行 (第 $i + 1$ 行) 左数第一个危险的格子为第 $k$ 列的格子，或者全部是安全的。</p>
<p>如果左数第一个危险的格子是第 $k$ ($1 \leq k \leq j$) 列的格子，则发生这件事的概率为 $p^{k - 1}q$，保持安全的概率就是 $f_{i + 1, k - 1} \cdot f_{i, j - k}$，故总贡献为 $p^{k-1} \cdot q \cdot f_{i+1, k-1} \cdot f_{i, j-k}$ (约定 $f_{i, 0} = 1$)。</p>
<p>如果全部是安全的，则发生这件事的概率为 $p^j$，保持安全的概率就是 $f_{i + 1, j}$，故总贡献为 $p^j \cdot f_{i + 1, j}$。</p>
<p>故总转移方程为 (注意 <a href="../index.html?redirect=47#iverson" target="_blank">Iverson 约定</a>)</p>
<p>$$ f_{i, j} = [j = 0] + [j \neq 0][i \cdot j \leq K] \left( \sum_{k=1}^j p^{k-1} \cdot q \cdot f_{i+1, k-1} \cdot f_{i, j-k} + p^j \cdot f_{i + 1, j} \right)$$</p>
<p>答案就是 $f_{0, N}$，时间复杂度约为 $O(K^2 + n)$，大约能过 $70$ 分。</p>
<p>接下来考虑如何优化：</p>
<p>当 $j &gt; k$ 时，$i$ 只能等于 $0$，即只有 $f_{0, j}$ 是非零的，我们考虑这个转移有什么特殊之处。</p>
<p>代入 $i = 0$，利用当 $j &gt; k$ 时 $f_{1, j} = 0$， 可得</p>
<p>$$ f_{0, j} = \sum_{k = 1}^j p^{k - 1} \cdot q \cdot f_{1, k - 1} \cdot f_{0, j - k} + p^j \cdot f_{1, j}
= q \sum_{k = 1}^j p^{k - 1} \cdot f_{1, k - 1} \cdot f_{0, j - k}
= q \sum_{k = 1}^{K + 1} p^{k - 1} \cdot f_{1, k - 1} \cdot f_{0, j - k} $$</p>
<p>记 $a_i = f_{0, i}, x_i = p^i \cdot q \cdot f_{1, i}$，则</p>
<p>$$ a_j = \sum_{k = 0}^K x_i \cdot a_{j - k - 1} $$</p>
<p>可以看出，是一个 $K + 1$ 阶常系数线性齐次递推式，<del>由 Cayley-Hamilton 定理</del>，可以知道，任何一个 $a_i$ 都可以表示为 $a_0, a_1, \cdots, a_K$ 的一个线性组合。</p>
<p>而 $a_0, a_1, \cdots, a_K$ 均已知，因此可以轻松用多项式乘法和取模等操作 (不用 <code>FFT</code> 或 <code>FNTT</code>) 在 $O(K^2 \log n)$ 的时间内完成 (当然用 <code>FNTT</code> 的话可以在 $O(K \log K \log n)$ 时间内完成)。</p>
<p>UPD: 多项式乘法和取模的原理见<a href="../index.html?redirect=281" target="_blank">这里</a>。</p>

<h3>代码</h3>

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> N <span class="sh_number">1034</span>
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">typedef</span> <span class="sh_type">long</span> <span class="sh_type">long</span> ll<span class="sh_symbol">;</span>
<span class="sh_keyword">const</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span>mod <span class="sh_symbol">=</span> <span class="sh_number">998244353</span><span class="sh_symbol">;</span>
<span class="sh_keyword">const</span> <span class="sh_type">int</span> h <span class="sh_symbol">=</span> <span class="sh_number">1001</span><span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">Poly</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> deg<span class="sh_symbol">;</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_symbol">*</span>c<span class="sh_symbol">;</span>
    <span class="sh_function">Poly</span> <span class="sh_symbol">():</span> <span class="sh_function">deg</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>c <span class="sh_symbol">=</span> NULL<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_symbol">~</span><span class="sh_function">Poly</span> <span class="sh_symbol">()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>c<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>c<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">init</span><span class="sh_symbol">()</span> <span class="sh_cbracket">{</span><span class="sh_function">memset</span><span class="sh_symbol">(</span>c<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_symbol">-~</span>deg <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">3</span><span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">copy</span><span class="sh_symbol">(</span><span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>src<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_function">memcpy</span><span class="sh_symbol">(</span>c<span class="sh_symbol">,</span> src<span class="sh_symbol">.</span>c<span class="sh_symbol">,</span> <span class="sh_symbol">-~</span>deg <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">3</span><span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">resize</span><span class="sh_symbol">(</span><span class="sh_type">int</span> degree <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>deg <span class="sh_symbol">=</span> degree<span class="sh_symbol">;</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span>c<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>c<span class="sh_symbol">);</span> c <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> ll<span class="sh_symbol">[-~</span>deg<span class="sh_symbol">];</span> <span class="sh_function">init</span><span class="sh_symbol">();</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">init_copy</span><span class="sh_symbol">(</span><span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>src<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>deg <span class="sh_symbol">=</span> src<span class="sh_symbol">.</span>deg<span class="sh_symbol">;</span> <span class="sh_keyword">if</span><span class="sh_symbol">(</span>c<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>c<span class="sh_symbol">);</span> c <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> ll<span class="sh_symbol">[-~</span>deg<span class="sh_symbol">];</span> <span class="sh_function">copy</span><span class="sh_symbol">(</span>src<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">init_const</span><span class="sh_symbol">(</span><span class="sh_usertype">ll</span><span class="sh_normal"> </span>c0<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_function">resize</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">);</span> c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> c0<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">init_linear</span><span class="sh_symbol">(</span><span class="sh_usertype">ll</span><span class="sh_normal"> </span>c0<span class="sh_symbol">,</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span>c1<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_function">resize</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">);</span> c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> c0<span class="sh_symbol">;</span> c<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> c1<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">print</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span><span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"Degree: %d, Coefficient: "</span><span class="sh_symbol">,</span> deg<span class="sh_symbol">);</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_type">int</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> deg<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> <span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"%lld%c"</span><span class="sh_symbol">,</span> c<span class="sh_symbol">[</span>i<span class="sh_symbol">],</span> i<span class="sh_symbol">==</span>deg<span class="sh_symbol">?</span><span class="sh_string">'</span><span class="sh_specialchar">\n</span><span class="sh_string">'</span><span class="sh_symbol">:</span><span class="sh_string">' '</span><span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_type">void</span> <span class="sh_function">PolyMul</span><span class="sh_symbol">(</span><span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>a<span class="sh_symbol">,</span> <span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>b<span class="sh_symbol">,</span> <span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>c<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_usertype">Poly</span><span class="sh_normal"> </span>ret<span class="sh_symbol">;</span>
    ret<span class="sh_symbol">.</span><span class="sh_function">resize</span><span class="sh_symbol">(</span>a<span class="sh_symbol">.</span>deg <span class="sh_symbol">+</span> b<span class="sh_symbol">.</span>deg<span class="sh_symbol">);</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> a<span class="sh_symbol">.</span>deg<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>j <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> j <span class="sh_symbol">&lt;=</span> b<span class="sh_symbol">.</span>deg<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>j<span class="sh_symbol">)</span>
            <span class="sh_symbol">(</span>ret<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> j<span class="sh_symbol">]</span> <span class="sh_symbol">+=</span> a<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> b<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>j<span class="sh_symbol">])</span> <span class="sh_symbol">%=</span> mod<span class="sh_symbol">;</span>
    c<span class="sh_symbol">.</span><span class="sh_function">init_copy</span><span class="sh_symbol">(</span>ret<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">PolyRemainder</span><span class="sh_symbol">(</span><span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>a<span class="sh_symbol">,</span> <span class="sh_usertype">Poly</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>b<span class="sh_symbol">)</span><span class="sh_cbracket">{</span> <span class="sh_comment">// you should make sure the highest coefficent of b is 1</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>a<span class="sh_symbol">.</span>deg <span class="sh_symbol">&lt;</span> b<span class="sh_symbol">.</span>deg<span class="sh_symbol">)</span> <span class="sh_keyword">return</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> a<span class="sh_symbol">.</span>deg <span class="sh_symbol">-</span> b<span class="sh_symbol">.</span>deg<span class="sh_symbol">;</span> i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> <span class="sh_symbol">--</span>i<span class="sh_symbol">)</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>j <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> j <span class="sh_symbol">&lt;=</span> b<span class="sh_symbol">.</span>deg<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>j<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
            <span class="sh_symbol">(</span>a<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> j<span class="sh_symbol">]</span> <span class="sh_symbol">-=</span> a<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> b<span class="sh_symbol">.</span>deg<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> b<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>j<span class="sh_symbol">])</span> <span class="sh_symbol">%=</span> mod<span class="sh_symbol">;</span>
            a<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> j<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span> <span class="sh_symbol">?</span> a<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i <span class="sh_symbol">+</span> j<span class="sh_symbol">]</span> <span class="sh_symbol">+=</span> mod <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>a<span class="sh_symbol">.</span>deg <span class="sh_symbol">=</span> b<span class="sh_symbol">.</span>deg <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> a<span class="sh_symbol">.</span>deg <span class="sh_symbol">&amp;&amp;</span> <span class="sh_symbol">!</span>a<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>a<span class="sh_symbol">.</span>deg<span class="sh_symbol">];</span> <span class="sh_symbol">--</span>a<span class="sh_symbol">.</span>deg<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> n<span class="sh_symbol">;</span>
<span class="sh_usertype">ll</span><span class="sh_normal"> </span>p<span class="sh_symbol">,</span> q<span class="sh_symbol">,</span> ans<span class="sh_symbol">,</span> pp<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_usertype">ll</span><span class="sh_normal"> </span>f<span class="sh_symbol">[</span>N<span class="sh_symbol">][</span>N<span class="sh_symbol">],</span> a<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> x<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_usertype">Poly</span><span class="sh_normal"> </span>M<span class="sh_symbol">,</span> res<span class="sh_symbol">,</span> t<span class="sh_symbol">;</span>

<span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_function">gcdex</span><span class="sh_symbol">(</span><span class="sh_usertype">ll</span><span class="sh_normal"> </span>a<span class="sh_symbol">,</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span>b<span class="sh_symbol">,</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>b<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_usertype">ll</span><span class="sh_normal"> </span>d <span class="sh_symbol">=</span> <span class="sh_function">gcdex</span><span class="sh_symbol">(</span>b<span class="sh_symbol">,</span> a <span class="sh_symbol">%</span> b<span class="sh_symbol">,</span> y<span class="sh_symbol">,</span> x<span class="sh_symbol">);</span> y <span class="sh_symbol">-=</span> a <span class="sh_symbol">/</span> b <span class="sh_symbol">*</span> x<span class="sh_symbol">;</span> <span class="sh_keyword">return</span> d<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">else</span> <span class="sh_cbracket">{</span>x <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> y <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> <span class="sh_keyword">return</span> a<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>

<span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_function">Mul</span><span class="sh_symbol">(</span><span class="sh_type">int</span> count<span class="sh_symbol">,</span> <span class="sh_symbol">...)</span><span class="sh_cbracket">{</span>
    <span class="sh_usertype">va_list</span><span class="sh_normal"> </span>ptr<span class="sh_symbol">;</span>
    <span class="sh_function">va_start</span><span class="sh_symbol">(</span>ptr<span class="sh_symbol">,</span> count<span class="sh_symbol">);</span>
    <span class="sh_usertype">ll</span><span class="sh_normal"> </span>res <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_type">int</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> count<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> <span class="sh_symbol">(</span>res <span class="sh_symbol">*=</span> <span class="sh_function">va_arg</span><span class="sh_symbol">(</span>ptr<span class="sh_symbol">,</span> ll<span class="sh_symbol">))</span> <span class="sh_symbol">%=</span> mod<span class="sh_symbol">;</span>
    <span class="sh_function">va_end</span><span class="sh_symbol">(</span>ptr<span class="sh_symbol">);</span>
    <span class="sh_keyword">return</span> res<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_function">Cayley_Hamilton_Method</span><span class="sh_symbol">(</span><span class="sh_type">int</span> n<span class="sh_symbol">,</span> <span class="sh_type">int</span> k<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">;</span> ll _z <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    M<span class="sh_symbol">.</span><span class="sh_function">resize</span><span class="sh_symbol">(-~</span>k<span class="sh_symbol">);</span> M<span class="sh_symbol">.</span>c<span class="sh_symbol">[-~</span>k<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> k<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> <span class="sh_symbol">(</span>M<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_symbol">-</span>x<span class="sh_symbol">[</span>k <span class="sh_symbol">-</span> i<span class="sh_symbol">])</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span> <span class="sh_symbol">?</span> M<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">+=</span> mod <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    res<span class="sh_symbol">.</span><span class="sh_function">init_const</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>t<span class="sh_symbol">.</span><span class="sh_function">init_linear</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">);</span> n<span class="sh_symbol">;</span> n <span class="sh_symbol">&gt;&gt;=</span> <span class="sh_number">1</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>n <span class="sh_symbol">&amp;</span> <span class="sh_number">1</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">PolyMul</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> t<span class="sh_symbol">,</span> res<span class="sh_symbol">);</span> <span class="sh_function">PolyRemainder</span><span class="sh_symbol">(</span>res<span class="sh_symbol">,</span> M<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
        <span class="sh_function">PolyMul</span><span class="sh_symbol">(</span>t<span class="sh_symbol">,</span> t<span class="sh_symbol">,</span> t<span class="sh_symbol">);</span>
        <span class="sh_function">PolyRemainder</span><span class="sh_symbol">(</span>t<span class="sh_symbol">,</span> M<span class="sh_symbol">);</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> res<span class="sh_symbol">.</span>deg<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span>
        <span class="sh_symbol">(</span>_z <span class="sh_symbol">+=</span> res<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> a<span class="sh_symbol">[</span>i<span class="sh_symbol">])</span> <span class="sh_symbol">%=</span> mod<span class="sh_symbol">;</span>
    <span class="sh_keyword">return</span> _z<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_usertype">ll</span><span class="sh_normal"> </span><span class="sh_function">solve</span><span class="sh_symbol">(</span><span class="sh_type">int</span> z<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">,</span> k<span class="sh_symbol">;</span>
    <span class="sh_function">memset</span><span class="sh_symbol">(</span>f<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> f<span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> h<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> f<span class="sh_symbol">[</span>i<span class="sh_symbol">][</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>j <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> j <span class="sh_symbol">&lt;=</span> z<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>j<span class="sh_symbol">)</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_function">min</span><span class="sh_symbol">(</span>h<span class="sh_symbol">,</span> z <span class="sh_symbol">/</span> j<span class="sh_symbol">);</span> i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> <span class="sh_symbol">--</span>i<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
            <span class="sh_keyword">for</span><span class="sh_symbol">(</span>k <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> k <span class="sh_symbol">&lt;=</span> j<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>k<span class="sh_symbol">)</span>
                <span class="sh_symbol">(</span>f<span class="sh_symbol">[</span>i<span class="sh_symbol">][</span>j<span class="sh_symbol">]</span> <span class="sh_symbol">+=</span> <span class="sh_function">Mul</span><span class="sh_symbol">(</span><span class="sh_number">4</span><span class="sh_symbol">,</span> pp<span class="sh_symbol">[~-</span>k<span class="sh_symbol">],</span> q<span class="sh_symbol">,</span> f<span class="sh_symbol">[</span>i<span class="sh_symbol">][</span>j <span class="sh_symbol">-</span> k<span class="sh_symbol">],</span> f<span class="sh_symbol">[-~</span>i<span class="sh_symbol">][~-</span>k<span class="sh_symbol">]))</span> <span class="sh_symbol">&gt;=</span> mod <span class="sh_symbol">?</span> f<span class="sh_symbol">[</span>i<span class="sh_symbol">][</span>j<span class="sh_symbol">]</span> <span class="sh_symbol">-=</span> mod <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
            <span class="sh_symbol">(</span>f<span class="sh_symbol">[</span>i<span class="sh_symbol">][</span>j<span class="sh_symbol">]</span> <span class="sh_symbol">+=</span> pp<span class="sh_symbol">[</span>j<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> f<span class="sh_symbol">[-~</span>i<span class="sh_symbol">][</span>j<span class="sh_symbol">])</span> <span class="sh_symbol">%=</span> mod<span class="sh_symbol">;</span>
        <span class="sh_cbracket">}</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> z<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> a<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> f<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">][</span>i<span class="sh_symbol">];</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> z<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> x<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">Mul</span><span class="sh_symbol">(</span><span class="sh_number">3</span><span class="sh_symbol">,</span> pp<span class="sh_symbol">[</span>i<span class="sh_symbol">],</span> q<span class="sh_symbol">,</span> f<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">][</span>i<span class="sh_symbol">]);</span>
    <span class="sh_keyword">return</span> <span class="sh_function">Cayley_Hamilton_Method</span><span class="sh_symbol">(</span>n<span class="sh_symbol">,</span> z<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> k<span class="sh_symbol">,</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span>
    <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>n<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>k<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>i<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>j<span class="sh_symbol">);</span>
    <span class="sh_function">gcdex</span><span class="sh_symbol">(</span>j<span class="sh_symbol">,</span> mod<span class="sh_symbol">,</span> p<span class="sh_symbol">,</span> q<span class="sh_symbol">);</span> <span class="sh_symbol">((</span>p <span class="sh_symbol">*=</span> <span class="sh_symbol">(</span>ll<span class="sh_symbol">)</span>i<span class="sh_symbol">)</span> <span class="sh_symbol">%=</span> mod<span class="sh_symbol">)</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span> <span class="sh_symbol">?</span> p <span class="sh_symbol">+=</span> mod <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_symbol">(</span>q <span class="sh_symbol">=</span> <span class="sh_number">1</span> <span class="sh_symbol">-</span> p<span class="sh_symbol">)</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span> <span class="sh_symbol">?</span> q <span class="sh_symbol">+=</span> mod <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>pp<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> N<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> pp<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> pp<span class="sh_symbol">[~-</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> p <span class="sh_symbol">%</span> mod<span class="sh_symbol">;</span>
    <span class="sh_symbol">(</span>ans <span class="sh_symbol">=</span> <span class="sh_function">solve</span><span class="sh_symbol">(</span>k<span class="sh_symbol">)</span> <span class="sh_symbol">-</span> <span class="sh_function">solve</span><span class="sh_symbol">(~-</span>k<span class="sh_symbol">))</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span> <span class="sh_symbol">?</span> ans <span class="sh_symbol">+=</span> mod <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"%d</span><span class="sh_specialchar">\n</span><span class="sh_string">"</span><span class="sh_symbol">,</span> <span class="sh_symbol">(</span><span class="sh_type">int</span><span class="sh_symbol">)</span>ans<span class="sh_symbol">);</span>
     <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h3>坑</h3>
<p>其实出题人用 "模意义运算" 这招还是很阴的……</p>
<p>首先，不能利用大数定律暴力模拟，还有不能利用线性插值或者 Lagrange 插值等估计 $n$ 非常大时的值，来卡精度，而必须用各种鲜(qi)为(qi)人(guai)知(guai)的方法。</p>
<p>不过模意义下只是除法变成了逆元，其它 DP 方程中加减乘都不用变化 <strong>(注意要及时取模！！！)</strong>。</p>
<p><strong>坑1：</strong>由于多项式取模的除数是一个 "首一多项式"，因此取模还是比较方便的。</p>
<p><strong>坑2：</strong>还有在构造除数多项式的时候，应该是个 $K + 1$ 次的，最高项系数为 $1$，其余项系数为 $x_0, x_1, \cdots, x_K$ <strong>倒置并取相反数</strong>，证明不是很难。</p>
<p>[Warning] 以下内容纯属扯淡：</p>
<p>两个小技巧：</p>
<p>蝌蚪<del>运算符</del> —— <code>-~</code> 和 <code>~-</code>：<code>-~x</code> 表示 <code>x + 1</code>，<code>~-x</code> 表示 <code>x - 1</code>。</p>
<p>快速趋向于<del>运算符</del> —— <code>--&gt;</code>：<code>while(x --&gt; 0)</code> 表示 $x$ 到 $0$ 下降遍历 (趋向于 $0$)。</p>
