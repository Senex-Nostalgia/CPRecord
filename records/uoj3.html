<h2>题目描述</h2>
<p>为了得到书法大家的真传，scx 下定决心去拜访住在魔法森林中的隐士。魔法森林可以被看成一个包含 <i>V</i> 个节点 <i>E</i> 条边的无向图，节点标号为 1, 2, ..., <i>V</i>，边标号为 1, 2, ..., <i>E</i>。</p>
<p>初始时 scx 在 1 号节点，隐士在 <i>V</i> 号节点。她需要通过这一片魔法森林，才能够拜访到隐士。</p>
<p><b>(以下题面被魔改，想看原题可以<a href="http://uoj.ac/problem/3" target="_blank">戳这</a>)</b></p>
<p>然而魔法森林中每条边上都有一个<s>流氓</s>。每当她经过一条边的时候，这条边上的<s>流氓</s>就会对她 ■■■■■■。幸运的是，在 1 号节点住着两种守护精灵：A 型守护精灵与 B 型守护精灵。她可以借助它们的力量，达到自己的目的。</p>
<p>只要 scx 带上足够多的守护精灵，<s>流氓们</s>就不会对她 ■■■■■■ 了。具体来说，无向图中的每一条边 <i>e<sub>i</sub></i> 包含两个权值 <i>a<sub>i</sub></i> 与 <i>b<sub>i</sub></i>。若身上携带的 A 型守护精灵个数<b>不少于</b> <i>a<sub>i</sub></i>，且 B 型守护精灵个数<b>不少于</b> <i>b<sub>i</sub></i>，这条边上的<s>流氓</s>就不会对她发起攻击。<b>当且仅当通过这片魔法森林的过程中 scx 没有收到攻击，她才能成功找到隐士。</b></p>
<p>由于携带守护精灵是一件非常麻烦的事，scx 想要知道，要能够成功拜访到隐士，最少需要携带守护精灵的总个数。<b>守护精灵的总个数</b>为 A 型守护精灵的个数与 B 型守护精灵的个数之和。</p>

<h2>输入格式</h2>
<p>第 1 行包含两个整数 <i>V</i>, <i>E</i>，表示无向图共有 <i>V</i> 个节点，<i>E</i> 条边。</p>
<p>接下来 <i>E</i> 行，第 <i>i</i> + 1 行包含 4 个正整数 <i>u<sub>i</sub></i>, <i>v<sub>i</sub></i>, <i>a<sub>i</sub></i>, <i>b<sub>i</sub></i>，描述第 <i>i</i> 条无向边。其中 <i>u<sub>i</sub></i> 与 <i>v<sub>i</sub></i> 为该边两个端点的标号，<i>a<sub>i</sub></i> 与 <i>b<sub>i</sub></i> 的含义如题所述。</p>
<p>注意数据中可能包含重边与自环。</p>

<h2>输出格式</h2>
<p>输出一行一个整数：如果 scx 可以成功拜访到隐士，输出她最少需要携带的<b>守护精灵的总个数</b>；如果无论如何她都无法拜访到隐士，输出 <code>-1</code>。</p>

<h2>题解</h2>
<p>(题外话：首先，动态树的模板<s>假装你们都会了，也应该是非常熟练的</s>。但是应用也必须熟练掌握。)</p>
<p>先考虑只有一种守护精灵的情况 (也就是边权只有一个)。那么各位大佬可以立即发现这是一道斯波题，直接按权排序后用类似 Kruskal 的 Minimum Spanning Tree 的思想，用一个并查集维护点 1 和点 <i>V</i> 是否连通，一旦连通，则当前加的边权就是点 1 到点 <i>V</i> 的最大权值，可以看出，这就是最后的答案。</p>
<p>现在考虑有两种是守护精灵的情况 (双边权)，用类似的思想，按照 <i>a<sub>i</sub></i> 排序后依次加边。若点 1 和点 <i>V</i> 已连通，则需要<span style="color: red">计算出点 1 到点 <i>V</i> 的路径上的 <i>b<sub>i</sub></i> 权值的最大值</span>，得到答案，<b>但是不能 <code>break;</code></b>，应该更新答案 (可能后来的 <i>b<sub>i</sub></i> 会非常小)。</p>
<p>如果<span style="color: red">加入边 <i>e<sub>j</sub></i> = (<i>u<sub>j</sub></i>, <i>v<sub>j</sub></i>) </span>时，两点已连通 (可能已经是树，或者像 Kruskal 一样跑到了圈)，则形成了圈，可以看到，随便在圈中丢一条边，连通性是不变的。</p>
<p>所以可以<span style="color: red">计算出 (加 <i>e<sub>j</sub></i> 之前) 点 <i>u<sub>j</sub></i> 到点 <i>v<sub>j</sub></i> 的路径上 <i>b<sub>i</sub></i> 权值的最大值</span>，如果 <i>b<sub>j</sub></i> ≥ <i>b<sub>i</sub></i>，可以看出边 <i>e<sub>j</sub></i> 是毫无意义的，所以不加。</p>
<p>如果 <i>b<sub>j</sub></i> &lt; <i>b<sub>i</sub></i>，可以看出 <i>e<sub>j</sub></i> 这条边还是有用武之地的，然而在不插入 <i>e<sub>j</sub></i> 这条边时的答案是已知的，所以考虑有这条边的情况，所以可以<span style="color: red">把 <i>b<sub>i</sub></i> 所对应的 <i>e<sub>i</sub></i> 删去</span>。</p>
<p>考虑红色的四个操作：加边、删边、树上路径询问，可以轻松发现，这可以用 Link-Cut Tree 解决。</p>
<p>(scx: 然而 Link-Cut Tree 不好处理边权最大值啊！)</p>
<p>所以这里有一个<del>奇技淫巧</del> ——裂边操作：可以对每一条边添加一个对应于那条边的点 (比如 <i>e<sub>i</sub></i> 对应 <i>v</i><sub><i>V</i> + <i>i</i></sub>)，然后将 <i>e<sub>i</sub></i> 分裂成两条边，分别与那个点相连。</p>
<p>然后只要在 Link-Cut Tree 中 <code>update()</code> 函数更新在原树中某点到叶子的重链中，<i>b<sub>i</sub></i> 权值的最大值所在的边的编号 (<i>i</i>) 就可以啦。</code>

<h2>代码</h2>

<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> <span class="sh_usertype">pa</span><span class="sh_normal"> </span>p<span class="sh_symbol">[</span>nd<span class="sh_symbol">]</span>
<span class="sh_preproc">#define</span> <span class="sh_usertype">root</span><span class="sh_normal"> </span>nd<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span>
<span class="sh_preproc">#define</span> maxV <span class="sh_number">50034</span>
<span class="sh_preproc">#define</span> maxE <span class="sh_number">100034</span>
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">node</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> v<span class="sh_symbol">,</span> rev<span class="sh_symbol">,</span> c<span class="sh_symbol">[</span><span class="sh_number">2</span><span class="sh_symbol">],</span> p<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>nd<span class="sh_symbol">[</span>maxV <span class="sh_symbol">+</span> maxE<span class="sh_symbol">];</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">UFind</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> sz<span class="sh_symbol">,</span> <span class="sh_symbol">*</span>p<span class="sh_symbol">;</span>
    <span class="sh_function">UFind</span> <span class="sh_symbol">():</span> <span class="sh_function">sz</span><span class="sh_symbol">(</span><span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>p <span class="sh_symbol">=</span> NULL<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_symbol">~</span><span class="sh_function">UFind</span> <span class="sh_symbol">()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>p<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>p<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">resize</span><span class="sh_symbol">(</span><span class="sh_type">int</span> size<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>p<span class="sh_symbol">)</span> <span class="sh_keyword">delete</span> <span class="sh_symbol">[]</span> <span class="sh_symbol">(</span>p<span class="sh_symbol">);</span> p <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> <span class="sh_type">int</span><span class="sh_symbol">[(</span>sz <span class="sh_symbol">=</span> size<span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">];</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_type">int</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> sz<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> p<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> i<span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">int</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> x <span class="sh_symbol">==</span> p<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">?</span> x <span class="sh_symbol">:</span> p<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span>p<span class="sh_symbol">[</span>x<span class="sh_symbol">]);</span><span class="sh_cbracket">}</span>
    <span class="sh_type">bool</span> <span class="sh_function">test</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">,</span> <span class="sh_type">bool</span> un <span class="sh_symbol">=</span> <span class="sh_keyword">false</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">((</span>x <span class="sh_symbol">=</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span>x<span class="sh_symbol">))</span> <span class="sh_symbol">==</span> <span class="sh_symbol">(</span>y <span class="sh_symbol">=</span> <span class="sh_function">ancestor</span><span class="sh_symbol">(</span>y<span class="sh_symbol">)))</span> <span class="sh_keyword">return</span> <span class="sh_keyword">true</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>un<span class="sh_symbol">)</span> p<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> y<span class="sh_symbol">;</span> <span class="sh_keyword">return</span> <span class="sh_keyword">false</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">edge</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> u<span class="sh_symbol">,</span> v<span class="sh_symbol">,</span> a<span class="sh_symbol">,</span> b<span class="sh_symbol">;</span>
    <span class="sh_function">edge</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> u0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> v0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> a0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> b0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">):</span> <span class="sh_function">u</span><span class="sh_symbol">(</span>u0<span class="sh_symbol">),</span> <span class="sh_function">v</span><span class="sh_symbol">(</span>v0<span class="sh_symbol">),</span> <span class="sh_function">a</span><span class="sh_symbol">(</span>a0<span class="sh_symbol">),</span> <span class="sh_function">b</span><span class="sh_symbol">(</span>b0<span class="sh_symbol">)</span> <span class="sh_cbracket">{}</span>
    <span class="sh_usertype">edge</span><span class="sh_normal"> </span><span class="sh_symbol">*</span><span class="sh_function">scan</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span><span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>u<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>v<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>a<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>b<span class="sh_symbol">);</span> <span class="sh_keyword">return</span> <span class="sh_keyword">this</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_type">bool</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;</span> <span class="sh_symbol">(</span><span class="sh_keyword">const</span> edge <span class="sh_symbol">&amp;</span>_<span class="sh_symbol">)</span> <span class="sh_keyword">const</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> a <span class="sh_symbol">&lt;</span> _<span class="sh_symbol">.</span>a<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_type">int</span> V<span class="sh_symbol">,</span> E<span class="sh_symbol">,</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">;</span>
<span class="sh_type">int</span> x<span class="sh_symbol">,</span> ans<span class="sh_symbol">;</span>
<span class="sh_usertype">node</span><span class="sh_normal"> </span>g<span class="sh_symbol">;</span>
<span class="sh_usertype">edge</span><span class="sh_normal"> </span>e<span class="sh_symbol">[</span>maxE<span class="sh_symbol">];</span>
<span class="sh_usertype">UFind</span><span class="sh_normal"> </span>uf<span class="sh_symbol">;</span>

<span class="sh_keyword">inline</span> <span class="sh_type">int</span> <span class="sh_function">dir</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_symbol">!</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p <span class="sh_symbol">?</span> <span class="sh_symbol">-</span><span class="sh_number">1</span> <span class="sh_symbol">:</span> x <span class="sh_symbol">==</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>pa<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">?</span> <span class="sh_number">0</span> <span class="sh_symbol">:</span> x <span class="sh_symbol">==</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>pa<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">?</span> <span class="sh_number">1</span> <span class="sh_symbol">:</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">reverse</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">swap</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">],</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">]);</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>rev <span class="sh_symbol">^=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">push_down</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>rev<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">reverse</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]);</span> <span class="sh_function">reverse</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">]);</span><span class="sh_cbracket">}</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>rev <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">pull_down</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(~</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>x<span class="sh_symbol">))</span> <span class="sh_function">pull_down</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">);</span> <span class="sh_function">push_down</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">up</span><span class="sh_symbol">(</span><span class="sh_type">int</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_keyword">const</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>e<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>b <span class="sh_symbol">&lt;</span> e<span class="sh_symbol">[</span>y<span class="sh_symbol">].</span>b <span class="sh_symbol">?</span> x <span class="sh_symbol">=</span> y <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">update</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>v <span class="sh_symbol">=</span> <span class="sh_function">max</span><span class="sh_symbol">(</span>x <span class="sh_symbol">-</span> V<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">);</span>
    <span class="sh_function">up</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>v<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">][</span>nd<span class="sh_symbol">].</span>v<span class="sh_symbol">);</span>
    <span class="sh_function">up</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>v<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">][</span>nd<span class="sh_symbol">].</span>v<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">rotate</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> y <span class="sh_symbol">=</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">,</span> d <span class="sh_symbol">=</span> <span class="sh_symbol">!</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span>
    nd<span class="sh_symbol">[</span>y<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[!</span>d<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span>d<span class="sh_symbol">]].</span>p <span class="sh_symbol">=</span> y<span class="sh_symbol">;</span>
    x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p <span class="sh_symbol">=</span> y<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(~</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>y<span class="sh_symbol">))</span> y<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>pa<span class="sh_symbol">.</span>c<span class="sh_symbol">[</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>y<span class="sh_symbol">)]</span> <span class="sh_symbol">=</span> x<span class="sh_symbol">;</span>
    nd<span class="sh_symbol">[</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span>d<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> y<span class="sh_symbol">].</span>p <span class="sh_symbol">=</span> x<span class="sh_symbol">;</span>
    <span class="sh_function">update</span><span class="sh_symbol">(</span>y<span class="sh_symbol">);</span> <span class="sh_function">update</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">splay</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_function">pull_down</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_symbol">~</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_function">rotate</span><span class="sh_symbol">(</span>x<span class="sh_symbol">))</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(~</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">))</span> <span class="sh_function">rotate</span><span class="sh_symbol">(</span><span class="sh_function">dir</span><span class="sh_symbol">(</span>x<span class="sh_symbol">)</span> <span class="sh_symbol">^</span> <span class="sh_function">dir</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">)</span> <span class="sh_symbol">?</span> x <span class="sh_symbol">:</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">access</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">for</span><span class="sh_symbol">(</span><span class="sh_type">int</span> y <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x<span class="sh_symbol">;</span> y <span class="sh_symbol">=</span> x<span class="sh_symbol">,</span> x <span class="sh_symbol">=</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_function">splay</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">1</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> y<span class="sh_symbol">;</span> <span class="sh_function">update</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span><span class="sh_cbracket">}}</span>

<span class="sh_type">void</span> <span class="sh_function">make_root</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">access</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_function">splay</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_function">reverse</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">find_root</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">access</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_function">splay</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_keyword">for</span><span class="sh_symbol">(;</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">];</span> x <span class="sh_symbol">=</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]);</span> <span class="sh_keyword">return</span> x<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">link</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">make_root</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p <span class="sh_symbol">=</span> y<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">split</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">make_root</span><span class="sh_symbol">(</span>x<span class="sh_symbol">);</span> <span class="sh_function">access</span><span class="sh_symbol">(</span>y<span class="sh_symbol">);</span> <span class="sh_function">splay</span><span class="sh_symbol">(</span>y<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">cut</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">split</span><span class="sh_symbol">(</span>x<span class="sh_symbol">,</span> y<span class="sh_symbol">);</span> x<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>p <span class="sh_symbol">=</span> y<span class="sh_symbol">[</span>nd<span class="sh_symbol">].</span>c<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> <span class="sh_function">update</span><span class="sh_symbol">(</span>y<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">query</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">split</span><span class="sh_symbol">(</span>x<span class="sh_symbol">,</span> y<span class="sh_symbol">);</span> <span class="sh_keyword">return</span> y<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">cd</span><span class="sh_symbol">(</span><span class="sh_type">int</span> h<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>uf<span class="sh_symbol">.</span><span class="sh_function">test</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">,</span> V<span class="sh_symbol">))</span><span class="sh_cbracket">{</span>
        <span class="sh_usertype">node</span><span class="sh_normal"> </span>g <span class="sh_symbol">=</span> nd<span class="sh_symbol">[</span><span class="sh_function">query</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">,</span> V<span class="sh_symbol">)];</span>
        <span class="sh_type">int</span> res <span class="sh_symbol">=</span> e<span class="sh_symbol">[</span>g<span class="sh_symbol">.</span>v<span class="sh_symbol">].</span>b <span class="sh_symbol">+</span> e<span class="sh_symbol">[</span>h<span class="sh_symbol">].</span>a<span class="sh_symbol">;</span>
        <span class="sh_symbol">(</span><span class="sh_type">unsigned</span><span class="sh_symbol">)</span>res <span class="sh_symbol">&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">unsigned</span><span class="sh_symbol">)</span>ans <span class="sh_symbol">?</span> ans <span class="sh_symbol">=</span> res <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>V<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>E<span class="sh_symbol">);</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> E<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> e<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span><span class="sh_function">scan</span><span class="sh_symbol">();</span>
    <span class="sh_function">sort</span><span class="sh_symbol">(</span>e <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> e <span class="sh_symbol">+</span> <span class="sh_symbol">(</span>E <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">));</span>
    uf<span class="sh_symbol">.</span><span class="sh_function">resize</span><span class="sh_symbol">(</span>V<span class="sh_symbol">);</span>
    ans <span class="sh_symbol">=</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> E<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
        <span class="sh_usertype">edge</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>z <span class="sh_symbol">=</span> e<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>uf<span class="sh_symbol">.</span><span class="sh_function">test</span><span class="sh_symbol">(</span>z<span class="sh_symbol">.</span>u<span class="sh_symbol">,</span> z<span class="sh_symbol">.</span>v<span class="sh_symbol">,</span> <span class="sh_keyword">true</span><span class="sh_symbol">))</span><span class="sh_cbracket">{</span>
            g <span class="sh_symbol">=</span> nd<span class="sh_symbol">[</span><span class="sh_function">query</span><span class="sh_symbol">(</span>z<span class="sh_symbol">.</span>u<span class="sh_symbol">,</span> z<span class="sh_symbol">.</span>v<span class="sh_symbol">)];</span>
            <span class="sh_keyword">if</span><span class="sh_symbol">(</span>e<span class="sh_symbol">[</span>g<span class="sh_symbol">.</span>v<span class="sh_symbol">].</span>b <span class="sh_symbol">&gt;</span> e<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>b<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
                <span class="sh_function">cut</span><span class="sh_symbol">(</span>e<span class="sh_symbol">[</span>g<span class="sh_symbol">.</span>v<span class="sh_symbol">].</span>u<span class="sh_symbol">,</span> g<span class="sh_symbol">.</span>v <span class="sh_symbol">+</span> V<span class="sh_symbol">);</span>
                <span class="sh_function">cut</span><span class="sh_symbol">(</span>e<span class="sh_symbol">[</span>g<span class="sh_symbol">.</span>v<span class="sh_symbol">].</span>v<span class="sh_symbol">,</span> g<span class="sh_symbol">.</span>v <span class="sh_symbol">+</span> V<span class="sh_symbol">);</span>
            <span class="sh_cbracket">}</span><span class="sh_keyword">else</span><span class="sh_cbracket">{</span>
                <span class="sh_function">cd</span><span class="sh_symbol">(</span>i<span class="sh_symbol">);</span>
                <span class="sh_keyword">continue</span><span class="sh_symbol">;</span>
            <span class="sh_cbracket">}</span>
        <span class="sh_cbracket">}</span>
        nd<span class="sh_symbol">[</span>x <span class="sh_symbol">=</span> V <span class="sh_symbol">+</span> i<span class="sh_symbol">].</span>v <span class="sh_symbol">=</span> i<span class="sh_symbol">;</span>
        <span class="sh_function">link</span><span class="sh_symbol">(</span>z<span class="sh_symbol">.</span>u<span class="sh_symbol">,</span> x<span class="sh_symbol">);</span>
        <span class="sh_function">link</span><span class="sh_symbol">(</span>z<span class="sh_symbol">.</span>v<span class="sh_symbol">,</span> x<span class="sh_symbol">);</span>
        <span class="sh_function">cd</span><span class="sh_symbol">(</span>i<span class="sh_symbol">);</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"%d</span><span class="sh_specialchar">\n</span><span class="sh_string">"</span><span class="sh_symbol">,</span> ans<span class="sh_symbol">);</span>
    <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h2>坑</h2>
<p>毕竟是 Link-Cut Tree，坑肯定是有的，<s>结果交的第一发就 AC 了……</s></p>
<p><b>坑1：</b>因为动态树毕竟也是树 (这貌似是废话)，所以遇到环神马的就死循环了，然而我当时是先加边再删边，结果样例就死循环……</p>
<p><b>坑2：</b>在 <code>update()</code> 中，如果按照上面的对应法则，得到边的编号需要减掉一个 <i>V</i>，但是在更新原图还是那个的点的时候，点的编号 ≤ <i>V</i>，如果硬减 <i>V</i>，会导致出现负数，导致 (访问边的时候) 下标越界 (RE)，所以加个 max 就可以了：<code>x[nd].v = max(x - V, 0);</code></p>
