<h2>题目描述</h2>
<p>有 m 种糖果，第 i 种糖果的美味指数为 v<sub>i</sub>，在一棵 n 个节点的树上(可能重复)，第 i 个点的糖果种类为 C<sub>i</sub>，第 i 次品尝糖果的新奇指数为 w<sub>i</sub>，如果第 i 次品尝第 j 种糖果，愉悦指数增加 v<sub>j</sub>w<sub>i</sub>，共有两种操作：</p>
<ol>
<li><code>0 x y</code> 将第 x 个节点的糖果种类改成 y。</li>
<li><code>1 x y</code> 对 x 到 y 的路线询问愉悦指数。</li>
</ol>

<h2>输入格式</h2>
<p>第一行为三个正整数 n, m, q、分别表示节点个数、糖果种类数和操作次数。</p>
<p>第二行为大小为 m 的 v[] 数组。</p>
<p>第三行为大小为 n 的 w[] 数组。</p>
<p>接下来的 n - 1 行，每行一条边，描述这棵树。</p>
<p>随后的一行为大小为 n 的 c[] 数组。</p>
<p>接下来有 q 行，每行三个整数 t, x, y，表示一个操作，意义见题目描述。</p>

<h2>输出格式</h2>
<p>对于每个 t 为 1 的操作输出一行，用一个正整数表示答案。</p>

<h2>题解</h2>
<p><s>整个人都不好了(再也不想写莫队了)……</s></p>
<p><s>能不能不写题解啊……</s></p>
<p><s>(scx: 怎么了？写一下吧，让我也吃一吃糖果……)</s></p>
<p>好了好了，别闹了。这是一道树上带修莫队的题目<s>(听起来好高级)</s>，毕竟是一棵树，所以下意识地写了个 LCA(我习惯用 ST 算法，就是那个 RMQ 的)(于是产生了 dfs 序列<s>，悲剧从此开始</s>)，然后对询问分块，开始莫队。</p>
<p>因为是带修莫队，排序的时候，按照左端点所在块排序，再按照右端点所在块排序，最后按照该询问之前修改的次数(以下简称时间)从小到大排序。块的大小大概为 n<sup>2/3</sup> (这里是玄学的 n<sup>0.682936</sup>)。</p>
<p>(scx: 如何简单地把询问和操作分离呢？)</p>
<p>这可以开两个变量 c1, c0 分别统计操作1和操作0出现的次数，如果读入 <code>ch == 1</code>，则 ++c1，并将时间记为 c0，否则 ++c0，最后 <code>sort(qur + 1, qur + (c1 + 1), cmp);</code>。</p>
<p>因为是树上莫队，于是要 dfs 出一个括号序列，然后莫队，如果两个点不是"祖先-子孙"关系，则需对 LCA 特判(又产生了一个括号序列<s>，再次作下铺垫</s>)。</p>
<p>然后开始莫队，记录一下某种糖果吃了几次和某个点有没有访问，先调整时间到该次询问的时间，如果修改的糖被访问过，则需要先吐了再把它噎了(ps: 如果你看"吐"和"噎"不爽，请自行替换成"撤回"和"品尝")，其次调整左右端点(按照括号序列)，每次遇到一个糖，如果没噎就把它噎了，否则把它吐了。</p>
<p>噎糖 x 的时候，<code>cur += (ll)v[x] * w[++cnt[x]];</code>(记得开 long long 哦)，吐糖 x 的时候，<code>cur -= (ll)v[x] * w[cnt[x]--];</code>。查询位置 pos 的时候，<code>(vis[pos] ^= 1) ? eat(c[pos]) : spit(c[pos]);</code>(注意是先修改再判断)。这三个函数都可以开 <code>inline</code>)，这样，也不用分左右括号处理，非常方便。</p>
<p>(scx: 两个序列到底发生了什么故事呢？)</p>
<p>这就是我开头为什么内心崩溃<s>(Runtime Error)</s>的原因了，具体一两句也说不清，到底发生了什么，请先看 AC 代码，详情见"坑"部分。</p>

<h2>代码</h2>

<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> <span class="sh_function">block</span><span class="sh_symbol">(</span>i<span class="sh_symbol">)</span> <span class="sh_symbol">((</span>i <span class="sh_symbol">+</span> b <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">/</span>  b<span class="sh_symbol">)</span>
<span class="sh_preproc">#define</span> N <span class="sh_number">100034</span>
<span class="sh_preproc">#define</span> M <span class="sh_number">100034</span>
<span class="sh_preproc">#define</span> Q <span class="sh_number">100034</span>
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">typedef</span> <span class="sh_type">long</span> <span class="sh_type">long</span> ll<span class="sh_symbol">;</span>

<span class="sh_keyword">typedef</span> vector <span class="sh_symbol">&lt;</span><span class="sh_type">int</span><span class="sh_symbol">&gt;</span> vec<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">req</span><span class="sh_cbracket">{</span>
	<span class="sh_type">int</span> x<span class="sh_symbol">,</span> y<span class="sh_symbol">,</span> z<span class="sh_symbol">,</span> id<span class="sh_symbol">;</span>
	<span class="sh_function">req</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> x0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> y0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> z0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> id0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">):</span>
		<span class="sh_function">x</span><span class="sh_symbol">(</span>x0<span class="sh_symbol">),</span> <span class="sh_function">y</span><span class="sh_symbol">(</span>y0<span class="sh_symbol">),</span> <span class="sh_function">z</span><span class="sh_symbol">(</span>z0<span class="sh_symbol">),</span> <span class="sh_function">id</span><span class="sh_symbol">(</span>id0<span class="sh_symbol">)</span> <span class="sh_cbracket">{}</span>
	<span class="sh_usertype">req</span><span class="sh_normal"> </span><span class="sh_symbol">*</span><span class="sh_function">read</span><span class="sh_symbol">(</span><span class="sh_type">int</span> id0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_type">int</span> z0 <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
		<span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>y<span class="sh_symbol">);</span> id <span class="sh_symbol">=</span> id0<span class="sh_symbol">;</span> z <span class="sh_symbol">=</span> z0<span class="sh_symbol">;</span> <span class="sh_keyword">return</span> <span class="sh_keyword">this</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_comment">// normal</span>
<span class="sh_type">int</span> n<span class="sh_symbol">,</span> m<span class="sh_symbol">,</span> q<span class="sh_symbol">,</span> b<span class="sh_symbol">;</span>
<span class="sh_type">int</span> i<span class="sh_symbol">,</span> j<span class="sh_symbol">,</span> u0<span class="sh_symbol">,</span> v0<span class="sh_symbol">;</span>
<span class="sh_type">int</span> c0<span class="sh_symbol">,</span> c1<span class="sh_symbol">,</span> ch<span class="sh_symbol">;</span>
<span class="sh_type">int</span> v<span class="sh_symbol">[</span>M<span class="sh_symbol">],</span> w<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> c<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> la<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_usertype">vec</span><span class="sh_normal"> </span>g<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_comment">// for lca and tree</span>
<span class="sh_type">int</span> cunt<span class="sh_symbol">,</span> dep<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> ord<span class="sh_symbol">[</span>N <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">3</span><span class="sh_symbol">],</span> ordF<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> ordL<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span> <span class="sh_comment">// ordF[](ordL[]) is the first(last) timestamp a vertex appear </span>
<span class="sh_type">int</span> f<span class="sh_symbol">[</span><span class="sh_number">20</span><span class="sh_symbol">][</span>N <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">3</span><span class="sh_symbol">];</span>
<span class="sh_comment">// for query or modui</span>
<span class="sh_type">int</span> lp<span class="sh_symbol">,</span> rp<span class="sh_symbol">,</span> tp<span class="sh_symbol">;</span>
<span class="sh_type">int</span> vis<span class="sh_symbol">[</span>N<span class="sh_symbol">],</span> cnt<span class="sh_symbol">[</span>M<span class="sh_symbol">];</span> <span class="sh_comment">// vis[] for if point is visited, cnt[] for candy is eaten</span>
<span class="sh_usertype">ll</span><span class="sh_normal"> </span>cur<span class="sh_symbol">,</span> ans<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>
<span class="sh_usertype">req</span><span class="sh_normal"> </span>mod<span class="sh_symbol">[</span>Q<span class="sh_symbol">],</span> qur<span class="sh_symbol">[</span>Q<span class="sh_symbol">];</span>

<span class="sh_type">bool</span> <span class="sh_function">cmp</span><span class="sh_symbol">(</span><span class="sh_keyword">const</span> <span class="sh_usertype">req</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_keyword">const</span> <span class="sh_usertype">req</span><span class="sh_normal"> </span><span class="sh_symbol">&amp;</span>y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
	<span class="sh_type">int</span> bxx <span class="sh_symbol">=</span> <span class="sh_function">block</span><span class="sh_symbol">(</span>x<span class="sh_symbol">.</span>x<span class="sh_symbol">),</span> byx <span class="sh_symbol">=</span> <span class="sh_function">block</span><span class="sh_symbol">(</span>y<span class="sh_symbol">.</span>x<span class="sh_symbol">),</span> bxy <span class="sh_symbol">=</span> <span class="sh_function">block</span><span class="sh_symbol">(</span>x<span class="sh_symbol">.</span>y<span class="sh_symbol">),</span> byy <span class="sh_symbol">=</span> <span class="sh_function">block</span><span class="sh_symbol">(</span>y<span class="sh_symbol">.</span>y<span class="sh_symbol">);</span>
	<span class="sh_keyword">return</span> bxx <span class="sh_symbol">&lt;</span> byx <span class="sh_symbol">||</span> bxx <span class="sh_symbol">==</span> byx <span class="sh_symbol">&amp;&amp;</span> <span class="sh_symbol">(</span>bxy <span class="sh_symbol">&lt;</span> byy <span class="sh_symbol">||</span> bxy <span class="sh_symbol">==</span> byy <span class="sh_symbol">&amp;&amp;</span> x<span class="sh_symbol">.</span>z <span class="sh_symbol">&lt;</span> y<span class="sh_symbol">.</span>z<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">int</span> <span class="sh_function">dmin</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> dep<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> dep<span class="sh_symbol">[</span>y<span class="sh_symbol">]</span> <span class="sh_symbol">?</span> x <span class="sh_symbol">:</span> y<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">void</span> <span class="sh_function">dfs</span><span class="sh_symbol">(</span><span class="sh_type">int</span> node<span class="sh_symbol">,</span> <span class="sh_type">int</span> depth<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
	<span class="sh_type">bool</span> ok <span class="sh_symbol">=</span> <span class="sh_keyword">false</span><span class="sh_symbol">;</span>
	dep<span class="sh_symbol">[</span>node<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> depth<span class="sh_symbol">;</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>vec <span class="sh_symbol">::</span> <span class="sh_usertype">iterator</span><span class="sh_normal"> </span>it <span class="sh_symbol">=</span> g<span class="sh_symbol">[</span>node<span class="sh_symbol">].</span><span class="sh_function">begin</span><span class="sh_symbol">();</span> it <span class="sh_symbol">!=</span> g<span class="sh_symbol">[</span>node<span class="sh_symbol">].</span><span class="sh_function">end</span><span class="sh_symbol">();</span> <span class="sh_symbol">++</span>it<span class="sh_symbol">)</span>
		<span class="sh_keyword">if</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">[*</span>it<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
			ok <span class="sh_symbol">=</span> <span class="sh_keyword">true</span><span class="sh_symbol">;</span>
			<span class="sh_keyword">if</span><span class="sh_symbol">(</span>ordF<span class="sh_symbol">[</span>node<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span> ordF<span class="sh_symbol">[</span>node<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cunt<span class="sh_symbol">;</span>
			ord<span class="sh_symbol">[</span>cunt<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> node<span class="sh_symbol">;</span>
			<span class="sh_function">dfs</span><span class="sh_symbol">(*</span>it<span class="sh_symbol">,</span> depth <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">);</span>
			ord<span class="sh_symbol">[</span>cunt<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> node<span class="sh_symbol">;</span>
		<span class="sh_cbracket">}</span>
	<span class="sh_keyword">if</span><span class="sh_symbol">(!</span>ok<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>ordF<span class="sh_symbol">[</span>node<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cunt<span class="sh_symbol">;</span> ord<span class="sh_symbol">[</span>cunt<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> node<span class="sh_symbol">;</span> ord<span class="sh_symbol">[</span>cunt<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> node<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
	ordL<span class="sh_symbol">[</span>node<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cunt <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">int</span> <span class="sh_function">LCA</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">,</span> <span class="sh_type">int</span> y<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
	<span class="sh_type">int</span> L <span class="sh_symbol">=</span> <span class="sh_function">min</span><span class="sh_symbol">(</span>ordF<span class="sh_symbol">[</span>x<span class="sh_symbol">],</span> ordF<span class="sh_symbol">[</span>y<span class="sh_symbol">]),</span> R <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>ordF<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">^</span> ordF<span class="sh_symbol">[</span>y<span class="sh_symbol">]</span> <span class="sh_symbol">^</span> L<span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span>
	D <span class="sh_symbol">=</span> R <span class="sh_symbol">-</span> L<span class="sh_symbol">,</span> c <span class="sh_symbol">=</span> <span class="sh_symbol">(</span><span class="sh_type">int</span><span class="sh_symbol">)</span><span class="sh_function">floor</span><span class="sh_symbol">(</span><span class="sh_function">log2</span><span class="sh_symbol">(</span>D<span class="sh_symbol">)</span> <span class="sh_symbol">+</span> <span class="sh_number">1e-6</span><span class="sh_symbol">);</span>
	<span class="sh_keyword">return</span> <span class="sh_function">dmin</span><span class="sh_symbol">(</span>f<span class="sh_symbol">[</span>c<span class="sh_symbol">][</span>L<span class="sh_symbol">],</span> f<span class="sh_symbol">[</span>c<span class="sh_symbol">][</span>R <span class="sh_symbol">-</span> <span class="sh_symbol">(</span><span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> c<span class="sh_symbol">)]);</span>
<span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">spit</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>cur <span class="sh_symbol">-=</span> <span class="sh_symbol">(</span>ll<span class="sh_symbol">)</span>v<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> w<span class="sh_symbol">[</span>cnt<span class="sh_symbol">[</span>x<span class="sh_symbol">]--];</span><span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">eat</span><span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>cur <span class="sh_symbol">+=</span> <span class="sh_symbol">(</span>ll<span class="sh_symbol">)</span>v<span class="sh_symbol">[</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">*</span> w<span class="sh_symbol">[++</span>cnt<span class="sh_symbol">[</span>x<span class="sh_symbol">]];</span><span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span><span class="sh_type">int</span> pos<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_symbol">(</span>vis<span class="sh_symbol">[</span>pos<span class="sh_symbol">]</span> <span class="sh_symbol">^=</span> <span class="sh_number">1</span><span class="sh_symbol">)</span> <span class="sh_symbol">?</span> <span class="sh_function">eat</span><span class="sh_symbol">(</span>c<span class="sh_symbol">[</span>pos<span class="sh_symbol">])</span> <span class="sh_symbol">:</span> <span class="sh_function">spit</span><span class="sh_symbol">(</span>c<span class="sh_symbol">[</span>pos<span class="sh_symbol">]);</span><span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">modify</span><span class="sh_symbol">(</span><span class="sh_type">int</span> pos<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>vis<span class="sh_symbol">[</span>pos<span class="sh_symbol">])</span><span class="sh_cbracket">{</span><span class="sh_function">spit</span><span class="sh_symbol">(</span>c<span class="sh_symbol">[</span>pos<span class="sh_symbol">]);</span> <span class="sh_function">eat</span><span class="sh_symbol">(</span>c<span class="sh_symbol">[</span>pos<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> v<span class="sh_symbol">);</span><span class="sh_cbracket">}</span> <span class="sh_keyword">else</span> c<span class="sh_symbol">[</span>pos<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> v<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
	<span class="sh_comment">// init</span>
	<span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>n<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>m<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>q<span class="sh_symbol">);</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> m<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> v <span class="sh_symbol">+</span> i<span class="sh_symbol">);</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span> <span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> w <span class="sh_symbol">+</span> i<span class="sh_symbol">);</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
		<span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>u0<span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>v0<span class="sh_symbol">);</span>
		g<span class="sh_symbol">[</span>u0<span class="sh_symbol">].</span><span class="sh_function">push_back</span><span class="sh_symbol">(</span>v0<span class="sh_symbol">);</span>
		g<span class="sh_symbol">[</span>v0<span class="sh_symbol">].</span><span class="sh_function">push_back</span><span class="sh_symbol">(</span>u0<span class="sh_symbol">);</span>
	<span class="sh_cbracket">}</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span><span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> c <span class="sh_symbol">+</span> i<span class="sh_symbol">);</span> la<span class="sh_symbol">[</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> c<span class="sh_symbol">[</span>i<span class="sh_symbol">];</span><span class="sh_cbracket">}</span>
	<span class="sh_comment">// get lca</span>
	<span class="sh_function">memset</span><span class="sh_symbol">(</span>dep<span class="sh_symbol">,</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> dep<span class="sh_symbol">);</span>
	<span class="sh_function">memset</span><span class="sh_symbol">(</span>ordF<span class="sh_symbol">,</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> ordF<span class="sh_symbol">);</span>
	<span class="sh_function">memset</span><span class="sh_symbol">(</span>ordL<span class="sh_symbol">,</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> ordL<span class="sh_symbol">);</span>
	<span class="sh_function">dfs</span><span class="sh_symbol">(</span><span class="sh_number">1</span><span class="sh_symbol">,</span> cunt <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">);</span>
	<span class="sh_function">memcpy</span><span class="sh_symbol">(</span>f<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">],</span> ord<span class="sh_symbol">,</span> cunt <span class="sh_symbol">&lt;&lt;</span> <span class="sh_number">2</span><span class="sh_symbol">);</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>j <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> <span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> j <span class="sh_symbol">+</span> <span class="sh_number">1</span> <span class="sh_symbol">&lt;=</span> cunt<span class="sh_symbol">;</span> j<span class="sh_symbol">++)</span>
		<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> cunt <span class="sh_symbol">-</span> <span class="sh_symbol">(</span><span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> j <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">);</span> i<span class="sh_symbol">++)</span>
			f<span class="sh_symbol">[</span>j <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">][</span>i<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">dmin</span><span class="sh_symbol">(</span>f<span class="sh_symbol">[</span>j<span class="sh_symbol">][</span>i<span class="sh_symbol">],</span> f<span class="sh_symbol">[</span>j<span class="sh_symbol">][</span>i <span class="sh_symbol">+</span> <span class="sh_symbol">(</span><span class="sh_number">1</span> <span class="sh_symbol">&lt;&lt;</span> j<span class="sh_symbol">)]);</span>
	b <span class="sh_symbol">=</span> <span class="sh_symbol">(</span><span class="sh_type">int</span><span class="sh_symbol">)</span><span class="sh_function">pow</span><span class="sh_symbol">(</span>cunt<span class="sh_symbol">,</span> <span class="sh_number">0.682936</span><span class="sh_symbol">);</span>
	<span class="sh_comment">// modui</span>
	<span class="sh_function">memset</span><span class="sh_symbol">(</span>vis<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> vis<span class="sh_symbol">);</span>
	<span class="sh_function">memset</span><span class="sh_symbol">(</span>cnt<span class="sh_symbol">,</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> cnt<span class="sh_symbol">);</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>c0 <span class="sh_symbol">=</span> c1 <span class="sh_symbol">=</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> q<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span>
		<span class="sh_keyword">if</span><span class="sh_symbol">(</span><span class="sh_function">scanf</span><span class="sh_symbol">(</span><span class="sh_string">"%d"</span><span class="sh_symbol">,</span> <span class="sh_symbol">&amp;</span>ch<span class="sh_symbol">),</span> ch<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
			qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span><span class="sh_function">read</span><span class="sh_symbol">(++</span>c1<span class="sh_symbol">,</span> c0<span class="sh_symbol">);</span>
			<span class="sh_keyword">if</span><span class="sh_symbol">(</span>qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>x<span class="sh_symbol">[</span>ordF<span class="sh_symbol">]</span> <span class="sh_symbol">&gt;</span> qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>y<span class="sh_symbol">[</span>ordF<span class="sh_symbol">])</span> <span class="sh_function">swap</span><span class="sh_symbol">(</span>qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>x<span class="sh_symbol">,</span> qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>y<span class="sh_symbol">);</span>
			qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>x <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>x<span class="sh_symbol">[</span>ordL<span class="sh_symbol">]</span> <span class="sh_symbol">&lt;</span> qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>y<span class="sh_symbol">[</span>ordF<span class="sh_symbol">]</span> <span class="sh_symbol">?</span> qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>x<span class="sh_symbol">[</span>ordL<span class="sh_symbol">]</span> <span class="sh_symbol">:</span> qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>x<span class="sh_symbol">[</span>ordF<span class="sh_symbol">]);</span>
			qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>y <span class="sh_symbol">=</span> qur<span class="sh_symbol">[</span>c1<span class="sh_symbol">].</span>y<span class="sh_symbol">[</span>ordF<span class="sh_symbol">];</span>
		<span class="sh_cbracket">}</span><span class="sh_keyword">else</span><span class="sh_cbracket">{</span>
			mod<span class="sh_symbol">[</span>c0<span class="sh_symbol">].</span><span class="sh_function">read</span><span class="sh_symbol">(++</span>c0<span class="sh_symbol">);</span>
			mod<span class="sh_symbol">[</span>c0<span class="sh_symbol">].</span>z <span class="sh_symbol">=</span> la<span class="sh_symbol">[</span>mod<span class="sh_symbol">[</span>c0<span class="sh_symbol">].</span>x<span class="sh_symbol">];</span>
			la<span class="sh_symbol">[</span>mod<span class="sh_symbol">[</span>c0<span class="sh_symbol">].</span>x<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> mod<span class="sh_symbol">[</span>c0<span class="sh_symbol">].</span>y<span class="sh_symbol">;</span>
		<span class="sh_cbracket">}</span>
	<span class="sh_function">sort</span><span class="sh_symbol">(</span>qur <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> qur <span class="sh_symbol">+</span> <span class="sh_symbol">(</span>c1 <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">),</span> cmp<span class="sh_symbol">);</span>
	tp <span class="sh_symbol">=</span> cur <span class="sh_symbol">=</span> lp <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> rp <span class="sh_symbol">=</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> c1<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span><span class="sh_cbracket">{</span>
		<span class="sh_keyword">while</span><span class="sh_symbol">(</span>tp <span class="sh_symbol">&lt;</span> qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>z<span class="sh_symbol">)</span> <span class="sh_function">modify</span><span class="sh_symbol">(</span>mod<span class="sh_symbol">[</span>tp<span class="sh_symbol">].</span>x<span class="sh_symbol">,</span> mod<span class="sh_symbol">[++</span>tp<span class="sh_symbol">].</span>y<span class="sh_symbol">);</span>
		<span class="sh_keyword">while</span><span class="sh_symbol">(</span>tp <span class="sh_symbol">&gt;</span> qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>z<span class="sh_symbol">)</span> <span class="sh_function">modify</span><span class="sh_symbol">(</span>mod<span class="sh_symbol">[</span>tp<span class="sh_symbol">--].</span>x<span class="sh_symbol">,</span> mod<span class="sh_symbol">[</span>tp<span class="sh_symbol">].</span>z<span class="sh_symbol">);</span>
		<span class="sh_keyword">while</span><span class="sh_symbol">(</span>lp <span class="sh_symbol">&lt;</span> qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>x<span class="sh_symbol">)</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span>ord<span class="sh_symbol">[</span>lp<span class="sh_symbol">++]);</span>
		<span class="sh_keyword">while</span><span class="sh_symbol">(</span>lp <span class="sh_symbol">&gt;</span> qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>x<span class="sh_symbol">)</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span>ord<span class="sh_symbol">[--</span>lp<span class="sh_symbol">]);</span>
		<span class="sh_keyword">while</span><span class="sh_symbol">(</span>rp <span class="sh_symbol">&lt;</span> qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>y<span class="sh_symbol">)</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span>ord<span class="sh_symbol">[++</span>rp<span class="sh_symbol">]);</span>
		<span class="sh_keyword">while</span><span class="sh_symbol">(</span>rp <span class="sh_symbol">&gt;</span> qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>y<span class="sh_symbol">)</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span>ord<span class="sh_symbol">[</span>rp<span class="sh_symbol">--]);</span>
		u0 <span class="sh_symbol">=</span> <span class="sh_function">LCA</span><span class="sh_symbol">(</span>ord<span class="sh_symbol">[</span>lp<span class="sh_symbol">],</span> ord<span class="sh_symbol">[</span>rp<span class="sh_symbol">]);</span>
		v0 <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>u0 <span class="sh_symbol">==</span> ord<span class="sh_symbol">[</span>lp<span class="sh_symbol">]</span> <span class="sh_symbol">||</span> u0 <span class="sh_symbol">==</span> ord<span class="sh_symbol">[</span>rp<span class="sh_symbol">]);</span>
		<span class="sh_keyword">if</span><span class="sh_symbol">(!</span>v0<span class="sh_symbol">)</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span>u0<span class="sh_symbol">);</span>
		ans<span class="sh_symbol">[</span>qur<span class="sh_symbol">[</span>i<span class="sh_symbol">].</span>id<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> cur<span class="sh_symbol">;</span>
		<span class="sh_keyword">if</span><span class="sh_symbol">(!</span>v0<span class="sh_symbol">)</span> <span class="sh_function">deal</span><span class="sh_symbol">(</span>u0<span class="sh_symbol">);</span>
	<span class="sh_cbracket">}</span>
	<span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> c1<span class="sh_symbol">;</span> i<span class="sh_symbol">++)</span>
		<span class="sh_function">printf</span><span class="sh_symbol">(</span><span class="sh_string">"%lld</span><span class="sh_specialchar">\n</span><span class="sh_string">"</span><span class="sh_symbol">,</span> ans<span class="sh_symbol">[</span>i<span class="sh_symbol">]);</span>
	<span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h2>坑</h2>
<p><s>代码看过没？我相信至少一半的人都是看了题解的最后一句话直接下拉到这里的。</s></p>
<p>AC 这道题的过程比 AC 当年的"[lydsy1758]重建计划题"还要艰辛。<s>(也许是我太渣了吧，毕竟还是有人一遍 AC 的，也希望scx能一遍 AC)</s></p>
<p>看这个艰辛的路程，9 次 WA(6 次 0 分，3 次 97 分)，1 次 TLE(80 分)才换来一个 AC。<s>(当然也有人有二三十次 WA 的，希望不是你)</s></p>
<p><b>坑1：</b>先看下这个 TLE，因为当时我还天真地以为所有莫队都是<img src="https://latex.codecogs.com/gif.latex?\sqrt%20n" align="top">分块的，于是华丽地 TLE 了，因为带修莫队是 n<sup>2/3</sup> 分块(每块大小)。 </p>
<p><b>坑2：</b>开 long long，曾经因为它而产生了无数个 WA。(scx: ...)</p>
<p><b>坑3：</b>现在是讲那个序列的时候了。dfs序列，每个点访问的次数为子树个数 + 1, 而括号序列是每个点一头一尾访问两次，当时把它混为一谈，居然过样例了<s>(可能样例有点弱，就像当年的九条可怜做树状数组一样)。</s></p>
<p>(scx: 我看你最后的代码还是只有一个序列啊，不是说有两个不同的序列的吗？)</p>
<p>因此，<s>懒得无法形容的</s>我自己想出了一种办法，并证明了它的正确性，就是搜索的时候，每个点至少访问两次，返回父节点时这个点再访问两次，如树<code>(1(2(3,4),5(6))</code>的新序列为：<code>[1,2,3,3,2,2,4,4,2,1,1,5,6,6,5,1]</code>(dfs序列为<code>[1,2,3,2,4,2,1,5,6,5,1]</code>，括号序列为<code>[1,2,3,3,4,4,2,5,6,6,5,1]</code>)，这样，既可以正确用 RMQ 算法求 LCA，又可以当括号序列来莫队。</p>
<p>(scx: 看起来这个序列好像变长了的样子……)</p>
<p>说得对。虽然取得了一举两得的作用，但是牺牲的是内存和略微的编程复杂度(询问到底选择对应哪个 dfs 序)，于是，产生了<s>万恶的</s>坑4。</p>
<p><b>坑4：</b>发现坑3时，交了一发，97 分。看来是被人 hack 了。找了份标程，自己手打了十来组数据，没有问题。然后找来 Python 对拍，拍了十来分钟，没有结果，于是我又一句一句地对着代码人工查错了十分钟，什么都没查出来(毕竟我是二合一序列)，一耗就是半个小时，正当我准备放弃的时候，我又想起了那个序列，对。内存比平常的 dfs 序列和括号序列都要大。所以最后，无奈之下，我把数组开大了 4 倍。然后一交，居然过了！<s>(当时我都想哭出来了)</s>，半个小时的查错，居然又是一个数组开得不够大，以后我真是要如果不爆内存，我每次数组都开大个 4 倍……(scx: ......)</s>
