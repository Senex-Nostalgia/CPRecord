<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta charset="utf-8">
		<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">
		<title>[lydsy5514][lg5279][uoj466][loj3042][soj441][ZJOI2019]麻将</title>
		<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]}});</script>
		<script src="../additional_files/js/sh_main.min.js"></script>
		<script src="../additional_files/MathJax-master/MathJax.js?config=TeX-MML-AM_CHTML"></script>
	</head>
	<body>
		<h3>题目描述</h3>
		<p>今天，可怜想要打麻将，但是她的朋友们都去下自走棋了，因此可怜只能自己一个人打。可怜找了一套特殊的麻将，它有 $n$ ($n \geq 5$) 种不同的牌，大小分别为 $1$ 到 $n$，每种牌都有 $4$ 张。</p>
		<p>定义面子为三张大小相同或者大小相邻的麻将牌，即大小形如 $i, i, i$ ($1 \leq i \leq n$) 或者 $i, i + 1, i + 2$ ($1 \leq i \leq n - 2$)。</p>
		<p>定义对子为两张大小相同的麻将牌，即大小形如 $i, i$ ($1 \leq i \leq n$)。</p>
		<p>定义一个麻将牌集合 $S$ 是<strong>胡的</strong>当且仅当它的大小为 $14$ 且满足下面两个条件中的至少一个：</p>
		<ol>
			<li><p>$S$ 可以被划分成五个集合 $S_1$ 至 $S_5$。其中 $S_1$ 为对子，$S_2$ 至 $S_5$ 为面子。</p></li>
			<li><p>$S$ 可以被划分成七个集合 $S_1$ 至 $S_7$，它们都是对子，且对应的大小<strong>两两不同</strong>。</p></li>
		</ol>
		<p>举例来说，下列集合都是胡的 (这儿只标记了大小)：</p>
		<ol>
			<li>$\left\{ 1, 1, 1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 9, 9 \right\}$</li>
			<li>$\left\{ 1, 1, 2, 2, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8 \right\}$</li>
			<li>$\left\{ 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7 \right\}$</li>
		</ol>
		<p>而下列集合都不是胡的：</p>
		<ol>
			<li>$\left\{ 1, 1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 9, 9 \right\}$</li>
			<li>$\left\{ 1, 1, 1, 1, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8 \right\}$</li>
			<li>$\left\{ 1, 1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 9, 9, 11 \right\}$</li>
		</ol>
		<p>可怜先摸出了 $13$ 张牌，并把剩下的 $4 n - 13$ 张牌随机打乱。打乱是等概率随机的，即所有 $\left( 4 n - 13 \right) !$ 种排列都等概率出现。</p>
		<p>对于一个排列 $P$，可怜定义 $S_i$ 为可怜事先摸出的 $13$ 张牌加上 $P$ 中的前 $i$ 张牌构成的集合，定义 $P$ 的权值为<strong>最小的 $i$ 满足 $S_i$ 存在一个子集是胡的</strong>。如果你对麻将比较熟悉，不难发现 $P$ 的权值就是理论上的最早胡牌巡目数。注意到 $n \geq 5$ 的时候，$S_{4 n - 13}$ 总是存在胡的子集的，因此 $P$ 的权值是良定义的。</p>
		<p>现在可怜想要训练自己的牌效，因此她希望你能先计算出 $P$ 的权值的期望是多少。</p>

		<h3>输入格式</h3>
		<p>第一行包含一个正整数 $n$ ($5 \leq n \leq 100$)，表示这副特殊的麻将牌中的大小种类数。</p>
		<p>接下来的 $13$ 行，每行包含两个整数 $w, t$ ($1 \leq w \leq n; 1 \leq t \leq 4$)，表示可怜最开始摸出的第 $i$ 张牌是大小为 $w$ 的第 $t$ 张牌。保证二元组 $\left( w, t \right)$ 两两不同。</p>

		<h3>输出格式</h3>
		<p>输出一行一个整数，表示答案对 $998244353$ 取模后的值。</p>

		<h3>题解</h3>
		<p>先考虑如何判定一些牌构成的集合 $S$ 是否<strong>存在胡的子集</strong>。</p>
		<p>考虑按照大小<strong>从小到大</strong>进行处理。用 $f_{w, i, j}$ 表示当前已经处理完 $\leq w$ 的所有数，且剩下<strong>将要与后面的牌匹配成顺子的</strong> $\left( w - 1, w, \cdots \right)$ 有 $i$ 组 (即这 $i$ 组将会形成 $\left( w - 1, w, w + 1 \right)$，$\left( w, \cdots \right)$ 有 $j$ 组 (即这 $j$ 组将会形成 $\left( w, w + 1, w + 2 \right)$ 的情况下，当前已经匹配完成的<strong>面子</strong> (顺子 + 刻子) 数的最大值。</p>
		<p>可以注意到，$i, j &lt; 3$。否则，比如说 $i \geq 3$，意思是会形成三个顺子 —— $\left( w, w + 1, w + 2 \right)$，不妨将其改成三个刻子 —— $w^3, \left( w + 1 \right)^3, \left( w + 2 \right)^3$，不影响面子的数目。$j \geq 3$ 时同理。</p>
		<p>至于转移，考察有多少个 $w + 1$。首先，它至少需要有 $i + j$ 个。否则这些顺子就无法归位。</p>
		<p>对于多余的 $w + 1$，我们枚举有多少个是去组成顺子 $\left( w + 1, w + 2, w + 3 \right)$，然后对于剩下的 $w + 1$，显然是贪心地组成刻子 <del>(除以 $3$ 下取整)</del>，剩下的牌就没用了。</p>
		<p>当然，在状态中还要记录当前是否已经确定<em>将眼</em> (就是那个一对的 $S_1$，好像没有正式名称)，以及 (不同大小的) 对子数量。</p>
		<p>具体的 DP 方程这里就不再写出来了。最后只需判断对子数量是否达到 $7$，以及是否存在某个 (已经确定将眼的) $f_{w, i, j} \geq 4$。</p>
		<p>这个 DP 的时间复杂度是 $O \left( n \cdot 2 \cdot 3^2 \right)$ 的。</p>
		<hr />
		<p>然而原题并不是判断一个给定的集合是否存在胡的子集，而是存在 "加牌" 的操作。</p>
		<p>首先根据套路，我们讲<strong>整型随机变量的期望</strong>转化成<strong>概率的问题</strong>。即有多大的概率，摸了 $i - 13$ 张牌 ($13 \leq i \leq 4 n$，即当前共有 $i$ 张牌) 后仍然不胡。</p>
		<p>将概率变成计数，也就是：对于所有长度为 $i$，且初始 $13$ 张麻将给定的麻将排列 (共 $\left( 4 n - 13 \right)^{\underline {i - 13}} = \dfrac {\left( 4 n - 13 \right)!} {\left( 4 n - i \right)!}$ 种)，有多少个排列是<strong>不存在胡的子集</strong>的。</p>
		<p>设这样的排列有 $p_i$ 种，那么摸了 $i - 13$ 张牌后仍然不胡的概率就是 $p_i$ 就等于 $\dfrac {p_i \cdot \left( 4 n - i \right)!} {\left( 4 n - 13 \right)!}$。</p>
		<p>于是最终的答案就只需要讲所有 $i$ 求和，即 $\displaystyle \sum_{i=13}^{4 n} \frac {p_i \cdot \left( 4 n - i \right)!} {\left( 4 n - 13 \right)!}$。</p>
		<p>于是问题的关键在于求 $p_i$。</p>
		<p>对于是排列，如果按照顺序添加元素，那么就很难判胡了。因为刚才我们的判定是从小到大加牌的。</p>
		<p>因此，这里我们也考虑<strong>从小到大加牌</strong>。由于大小相同的四张牌是不同的，于是我们可以将问题 (排列) 转化为选一个包含给定集合的 $i$ 元集 (组合)，最后乘上一个 $\left( i - 13 \right)!$。</p>
		<p>这样一来，DP 时就需要在状态中记录上一个 DP 的值了 (即 DP 套 DP！)，大体就是用 $g_{w, \mathbf f, t}$ 表示加完了 $\leq w$ 的所有数，当前 DP 数组为 $\mathbf f$，共有 $t$ 个对子<strong>且不胡</strong>的方案数。</p>
		<p>还是要注意到大小相同的四张牌是不同的，因此在枚举大小为 $w + 1$ 的牌有多少个的时候，不要忘记乘上一个适当的组合数 (二项式系数)。</p>
		<p>时间复杂度 $O \left( n \cdot 4^{2 \cdot 3^2} \cdot 7 \right)$，已经无法接受。</p>
		<hr />
		<p>那怎么办呢？显然把整个 DP 数组塞到状态里面来一看就非常愚蠢啊！通常有大量 DP 数组是不可能出现的，况且还可能存在大量 DP 数组是胡牌等价的！</p>
		<p>冷静分析一下，可以发现，其实第一个 DP 过程可以看成在一个<strong>有限状态自动机</strong>上匹配的过程。状态集合 $S$ 就是所有 DP 数组 $\mathbf f$ 构成的集合，"字符集" $\Sigma = \left\{ 0, 1, 2, 3, 4 \right\}$ 表示下一个大小的牌出现多少张，转移函数 $d$ 就是 DP 状态之间的转移，初始状态 $s_0 = \mathbf 0$，接受状态集合 $F$ 即所有胡牌的集合——即满足 "$t \geq 7$ 或存在已经确定将眼的 $f_{w, i, j} \geq 4$" 的所有 $\mathbf f$ 构成的集合。</p>
		<p>至于这个自动机收到的 "串" $c_1 c_2 \cdots c_n$，就表示每张牌 $i$ 的出现次数 $c_i$。</p>
		<p>而且，在 DP 套 DP 的过程中，难道不觉得和<strong>在自动机上 DP 很像</strong>吗？</p>
		<p>因此，我们要讲这个<del>辣鸡</del> DP 套 DP 转化成<strong>在自动机上 DP</strong>。</p>
		<p>而众所周知，<strong>有限状态自动机</strong> (DFA) 是存在<a href="../index.html?redirect=579" target="_blank"><strong>最小化</strong></a>的，而一个最小化自动机和它本身<strong>所识别的串的集合完全相同</strong>。也就是说，如果一个 "串" 被原自动机 "判胡"，<strong>当且仅当</strong>它被最小化自动机 "判胡"。</p>
		<p>于是我们所要做的，就是对这个自动机进行 "最小化"。</p>
		<p>我们使用一般自动机的最小化算法 (在<a href="../index.html?redirect=579" target="_blank">这里</a>也提到过)，也可以使用 dfs 等方法求出这个自动机的最小化。时间复杂度大约是 $O \left( \left| S \right|^2 \left| \Sigma \right| \cdot 2 \cdot 3^2 \right)$，不过实测跑得挺快的。</p>
		<p>由 Myhill-Nerode 定理，一个<strong>接受串</strong>集合固定的 DFA (如果存在) 的最小化在同构意义下唯一。因此，不管你是用哪种算法构造出来的，只要是最小自动机，同构意义下长得都一样。对于 "胡牌检验自动机" 来说，<strong style="color: red">它的最小化的状态数为 $567$</strong>，且 $\left| F \right| = 1$ (可以用来 check 一下)。</p>
		<p>于是只需在最小化自动机上 DP，DP 的时间复杂度就降为 $O \left( n^2 \left| S' \right| \right)$，就可以通过了。</p>

		<h3>代码</h3>

		<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp">#include &lt;bits/stdc++.h&gt;
#define MAM mahjong_automaton

typedef long long ll;
const int N = 108, N4 = N * 4, S = 2100, mod = 998244353;
const int C[5][5] = {{1, 0, 0, 0, 0}, {1, 1, 0, 0, 0}, {1, 2, 1, 0, 0}, {1, 3, 3, 1, 0}, {1, 4, 6, 4, 1}};

namespace mahjong_automaton {
	typedef unsigned long long u64, status;
	typedef std::unordered_map &lt;status, int&gt; map;
	const u64 mask1 = 0111111111ull, mask2 = 0222222222ull, mask4 = 0444444444ull, mask7 = 0777777777ull;

	int cnt = 0, d[S][5];
	map f;

	inline int min(const int x, const int y) {return x &lt; y ? x : y;}
	inline void up(char &amp;x, const char y) {x &lt; y ? x = y : 0;}
	inline bool HU(status x) {return x &gt;&gt; 54 &gt;= 7 || (x = (x &gt;&gt; 27 &amp; mask7) ^ mask2, x &amp; (~x - mask1) &amp; mask4);}

	status trans(status cur, int v) {
		int i, j, k, d, c, o = 0;
		static char f[2][3][3];
		status nxt = (u64)min((cur &gt;&gt; 54) + (v &gt;= 2), 7) &lt;&lt; 54;
		memset(f, -1, sizeof f);
		for (i = 0; i &lt; 2; ++i)
			for (j = 0; j &lt; 3; ++j)
				for (k = 0; k &lt; 3; ++k, o += 3)
					if (c = (cur &gt;&gt; o &amp; 7) - 1, ~c) {
						for (d = 0; d &lt; 3 &amp;&amp; j + k + d &lt;= v; ++d)
							up(f[i][k][d], min(c + j + (j + k + d + 3 &lt;= v), 4));
						for (d = 0; d &lt; 3 &amp;&amp; !i &amp;&amp; j + k + d &lt;= v - 2; ++d)
							up(f[1][k][d], min(c + j, 4));
					}
		for (o = i = 0; i &lt; 2; ++i)
			for (j = 0; j &lt; 3; ++j)
				for (k = 0; k &lt; 3; ++k, o += 3) nxt |= (f[i][j][k] + 1ull) &lt;&lt; o;
		return nxt;
	}

	int dfs(status x) {
		if (HU(x)) return 0;
		map::iterator it = f.find(x);
		if (it != f.end()) return it-&gt;second;
		int i, c = ++cnt; f.emplace(x, c);
		for (i = 0; i &lt;= 4; ++i) d[c][i] = dfs(trans(x, i));
		return c;
	}

	inline void init() {f.reserve(S), f.rehash(2003731), dfs(1);}
}

int n;
int c[N], fact[N * 4], finv[N * 4];
int dp[2][N * 4][S], (*cur)[S] = *dp, (*nxt)[S] = dp[1];

ll PowerMod(ll a, int n, ll c = 1) {for (; n; n &gt;&gt;= 1, a = a * a % mod) if (n &amp; 1) c = c * a % mod; return c;}

void init(int n) {
	int i;
	for (*fact = i = 1; i &lt;= n; ++i) fact[i] = (ll)fact[i - 1] * i % mod;
	finv[n] = PowerMod(fact[n], mod - 2);
	for (i = n; i; --i) finv[i - 1] = (ll)finv[i] * i % mod;
}

int main() {
	int i, j, ni, nj, d, w, S, tot; ll s;
	MAM::init();
	scanf("%d", &amp;n), init(4 * n);
	for (i = 0; i &lt; 13; ++i) scanf("%d%*d", &amp;w), ++c[--w];
	for (nxt[0][1] = 1, w = 0; w &lt; n; ++w) {
		std::swap(cur, nxt), memset(nxt, 0, sizeof *dp), tot += c[w];
		for (i = 0; i &lt;= 4 * w; ++i)
			for (j = 1; j &lt;= MAM::cnt; ++j) if ((s = cur[i][j]))
				for (d = 0; d &lt;= 4 - c[w]; ++d)
					ni = i + c[w] + d, nj = MAM::d[j][c[w] + d],
					nj &amp;&amp; (nxt[ni][nj] = (nxt[ni][nj] + s * C[4 - c[w]][d]) % mod);
	}
	for (S = 0, i = 13; i &lt; 4 * n; ++i)
		s = std::accumulate(nxt[i] + 1, nxt[i] + MAM::cnt, 0ll) % mod,
		S = (S + s * fact[i - 13] % mod * fact[4 * n - i]) % mod;
	printf("%lld\n", (ll)S * finv[4 * n - 13] % mod);
	return 0;
}

</code></pre></div>

		<h4>最小化自动机打表版</h4>

		<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp">#include &lt;bits/stdc++.h&gt;
#define MAM mahjong_automaton

typedef long long ll;
const int N = 108, N4 = N * 4, S = 575, mod = 998244353;
const int C[5][5] = {{1, 0, 0, 0, 0}, {1, 1, 0, 0, 0}, {1, 2, 1, 0, 0}, {1, 3, 3, 1, 0}, {1, 4, 6, 4, 1}};

namespace mahjong_automaton {
	const int cnt = 567, d[S][5] = {
		{0, 0, 0, 0, 0}, {1, 2, 3, 4, 5}, {1, 6, 7, 8, 9}, {10, 11, 12, 13, 14}, {15, 16, 17, 18, 19}, {15, 20, 21, 22, 23}, {1, 24, 25, 26, 27}, {10, 28, 29, 30, 31}, {15, 32, 33, 34, 35}, {15, 36, 37, 38, 39}, {10, 40, 41, 42, 43}, {10, 44, 45, 46, 47}, {48, 49, 50, 51, 52}, {53, 43, 54, 55, 56}, {53, 57, 58, 59, 60}, {15, 61, 62, 18, 63}, {15, 64, 65, 66, 67}, {53, 68, 69, 70, 71}, {72, 37, 73, 74, 75}, {72, 76, 77, 78, 79}, {15, 36, 80, 81, 39},
		{53, 82, 55, 56, 83}, {72, 84, 85, 60, 86}, {72, 87, 88, 86, 89}, {24, 90, 26, 27, 91}, {15, 92, 30, 31, 23}, {93, 94, 95, 96, 97}, {36, 98, 38, 39, 99}, {15, 16, 100, 18, 19}, {101, 102, 51, 52, 74}, {53, 82, 103, 104, 105}, {72, 84, 85, 106, 107}, {93, 94, 108, 109, 110}, {53, 57, 111, 112, 113}, {72, 37, 114, 115, 116}, {117, 118, 119, 120, 121}, {36, 122, 81, 39, 123}, {72, 76, 56, 83, 79}, {117, 118, 60, 86, 124}, {87, 125, 86, 89, 126}, {10, 127, 128, 129, 130}, {48, 131, 132, 133, 134},
		{53, 43, 135, 136, 137}, {53, 138, 139, 140, 141}, {15, 32, 142, 143, 144}, {101, 145, 146, 147, 148}, {53, 68, 149, 150, 151}, {72, 84, 152, 153, 116}, {48, 154, 155, 156, 157}, {101, 158, 159, 54, 160}, {161, 51, 162, 163, 164}, {165, 103, 166, 167, 168}, {169, 170, 171, 172, 173}, {53, 43, 174, 136, 137}, {165, 175, 176, 177, 178}, {169, 179, 164, 180, 89}, {169, 181, 168, 182, 126}, {72, 84, 183, 153, 116}, {169, 170, 184, 185, 186}, {169, 181, 187, 188, 126}, {189, 190, 89, 89, 0}, {15, 20, 191, 31, 23}, {53, 68, 192, 193, 194},
		{72, 195, 196, 197, 198}, {93, 199, 63, 81, 39}, {53, 57, 200, 201, 105}, {72, 84, 202, 203, 107}, {117, 204, 75, 86, 89}, {53, 57, 205, 206, 113}, {165, 207, 163, 164, 180}, {169, 170, 208, 182, 186}, {169, 181, 209, 173, 126}, {72, 80, 210, 74, 211}, {169, 170, 212, 209, 173}, {189, 88, 209, 89, 126}, {189, 120, 173, 126, 0}, {117, 204, 211, 116, 89}, {169, 181, 182, 186, 126}, {189, 190, 173, 126, 0}, {213, 89, 126, 0, 0}, {72, 195, 214, 105, 198}, {117, 118, 215, 216, 124}, {72, 37, 217, 74, 75}, {189, 190, 173, 89, 0},
		{117, 118, 218, 219, 121}, {169, 181, 187, 209, 126}, {213, 121, 126, 0, 0}, {87, 220, 116, 89, 89}, {189, 120, 186, 126, 0}, {221, 126, 0, 0, 0}, {24, 222, 223, 224, 225}, {36, 226, 227, 228, 229}, {15, 230, 231, 232, 39}, {93, 233, 234, 235, 236}, {93, 237, 238, 239, 240}, {53, 57, 241, 242, 190}, {117, 236, 153, 120, 121}, {117, 243, 244, 121, 126}, {36, 245, 246, 247, 248}, {87, 249, 124, 126, 0}, {53, 68, 149, 250, 251}, {101, 252, 253, 254, 255}, {256, 231, 52, 74, 211}, {165, 241, 257, 258, 89}, {169, 179, 259, 260, 126},
		{189, 190, 186, 89, 0}, {189, 88, 221, 89, 0}, {213, 121, 89, 0, 0}, {53, 57, 261, 262, 197}, {117, 236, 263, 216, 264}, {117, 243, 265, 86, 126}, {165, 55, 167, 266, 182}, {169, 170, 212, 267, 173}, {189, 190, 268, 89, 0}, {189, 115, 269, 89, 89}, {189, 270, 182, 126, 126}, {213, 121, 173, 0, 0}, {117, 236, 271, 272, 273}, {117, 243, 265, 244, 126}, {189, 88, 267, 89, 126}, {213, 89, 89, 0, 0}, {213, 126, 126, 0, 0}, {36, 226, 274, 275, 229}, {87, 276, 277, 126, 126}, {213, 126, 0, 0, 0}, {87, 249, 121, 126, 0},
		{221, 0, 0, 0, 0}, {10, 93, 43, 234, 235}, {48, 53, 278, 139, 140}, {53, 43, 279, 280, 281}, {53, 117, 137, 282, 272}, {48, 53, 157, 174, 136}, {283, 284, 285, 286, 287}, {284, 157, 288, 289, 290}, {284, 169, 286, 291, 292}, {284, 278, 293, 294, 295}, {169, 137, 296, 297, 298}, {169, 299, 290, 185, 300}, {53, 117, 137, 271, 272}, {284, 169, 289, 290, 185}, {169, 137, 291, 292, 301}, {169, 213, 298, 301, 0}, {53, 138, 302, 303, 304}, {72, 37, 305, 306, 75}, {117, 118, 307, 219, 121}, {53, 82, 255, 210, 74}, {284, 169, 308, 309, 310},
		{165, 207, 289, 311, 209}, {169, 179, 178, 188, 89}, {284, 169, 163, 164, 180}, {169, 137, 297, 186, 186}, {169, 181, 312, 300, 126}, {169, 299, 311, 209, 300}, {189, 88, 188, 89, 126}, {48, 131, 313, 314, 315}, {283, 316, 317, 318, 319}, {284, 157, 320, 288, 286}, {284, 278, 321, 322, 323}, {53, 68, 324, 325, 326}, {284, 278, 327, 328, 329}, {169, 170, 330, 310, 186}, {161, 331, 162, 163, 164}, {285, 308, 332, 333, 334}, {335, 336, 337, 89, 126}, {335, 338, 339, 126, 126}, {165, 340, 341, 163, 164}, {285, 163, 342, 343, 126}, {335, 258, 344, 89, 0},
		{335, 221, 126, 0, 0}, {169, 137, 287, 297, 298}, {169, 181, 266, 312, 126}, {285, 345, 346, 221, 0}, {347, 298, 89, 0, 0}, {347, 126, 0, 0, 0}, {284, 278, 348, 349, 350}, {165, 55, 351, 208, 182}, {285, 308, 333, 352, 334}, {335, 336, 337, 126, 126}, {335, 260, 334, 126, 0}, {189, 88, 312, 89, 126}, {347, 186, 334, 0, 0}, {189, 190, 298, 89, 0}, {347, 89, 126, 0, 0}, {169, 299, 353, 354, 300}, {285, 347, 334, 334, 0}, {347, 298, 355, 0, 0}, {347, 126, 126, 0, 0}, {335, 260, 126, 126, 0}, {347, 186, 0, 0, 0},
		{189, 115, 180, 89, 89}, {213, 121, 186, 0, 0}, {53, 82, 356, 214, 105}, {284, 357, 335, 358, 180}, {169, 137, 359, 260, 186}, {169, 181, 312, 186, 126}, {72, 87, 115, 116, 89}, {169, 179, 260, 186, 126}, {189, 190, 186, 126, 0}, {189, 221, 126, 0, 0}, {36, 98, 360, 39, 99}, {165, 189, 336, 312, 89}, {169, 179, 338, 267, 126}, {169, 181, 209, 268, 126}, {189, 88, 221, 126, 0}, {87, 125, 244, 89, 126}, {165, 55, 361, 362, 182}, {169, 170, 363, 292, 173}, {169, 170, 309, 310, 186}, {335, 258, 334, 89, 0}, {347, 186, 126, 0, 0},
		{169, 170, 364, 172, 173}, {189, 270, 267, 126, 126}, {335, 258, 89, 89, 0}, {213, 273, 298, 0, 0}, {169, 179, 338, 182, 126}, {169, 181, 221, 89, 0}, {213, 273, 89, 0, 0}, {169, 170, 363, 354, 173}, {169, 181, 365, 267, 126}, {213, 273, 173, 0, 0}, {87, 276, 79, 126, 126}, {221, 89, 0, 0, 0}, {24, 366, 367, 368, 369}, {93, 199, 370, 371, 275}, {36, 372, 373, 374, 375}, {36, 376, 125, 377, 89}, {36, 376, 220, 378, 89}, {117, 204, 120, 121, 126}, {87, 379, 121, 126, 0}, {87, 221, 126, 0, 0}, {380, 367, 232, 39, 123},
		{72, 370, 104, 105, 198}, {117, 118, 381, 216, 124}, {93, 382, 383, 384, 385}, {53, 138, 386, 387, 388}, {117, 236, 282, 272, 273}, {117, 389, 390, 391, 392}, {36, 372, 393, 394, 378}, {72, 76, 395, 396, 79}, {117, 118, 397, 398, 124}, {87, 379, 264, 89, 0}, {399, 242, 258, 89, 89}, {189, 400, 260, 126, 126}, {87, 379, 273, 89, 0}, {213, 121, 300, 0, 0}, {401, 402, 123, 378, 89}, {117, 243, 198, 79, 126}, {87, 379, 124, 89, 0}, {403, 89, 126, 0, 0}, {403, 89, 89, 0, 0}, {169, 137, 404, 182, 186}, {169, 181, 312, 173, 126},
		{101, 405, 406, 407, 408}, {284, 409, 410, 411, 412}, {165, 175, 413, 163, 178}, {165, 356, 414, 415, 168}, {256, 416, 52, 74, 211}, {335, 259, 343, 126, 126}, {347, 186, 344, 0, 0}, {335, 346, 221, 0, 0}, {347, 89, 89, 0, 0}, {165, 189, 258, 298, 89}, {169, 179, 260, 300, 126}, {169, 181, 188, 301, 126}, {213, 392, 126, 0, 0}, {189, 120, 300, 126, 0}, {335, 260, 355, 126, 0}, {347, 89, 0, 0, 0}, {347, 300, 126, 0, 0}, {347, 186, 89, 0, 0}, {189, 221, 89, 0, 0}, {169, 299, 417, 292, 300}, {213, 273, 301, 0, 0},
		{213, 392, 300, 0, 0}, {117, 204, 270, 79, 126}, {87, 379, 121, 89, 0}, {87, 221, 89, 0, 0}, {213, 89, 0, 0, 0}, {284, 169, 286, 287, 297}, {284, 169, 418, 419, 297}, {169, 137, 297, 298, 298}, {169, 299, 185, 300, 300}, {169, 299, 292, 301, 300}, {283, 420, 421, 422, 423}, {284, 157, 424, 288, 286}, {285, 286, 425, 333, 352}, {285, 289, 426, 427, 355}, {285, 289, 428, 429, 355}, {285, 286, 430, 333, 352}, {285, 347, 352, 352, 0}, {285, 347, 355, 355, 0}, {285, 347, 431, 431, 0}, {347, 298, 0, 0, 0}, {285, 286, 333, 352, 352},
		{285, 289, 427, 355, 355}, {285, 347, 431, 355, 0}, {285, 289, 429, 431, 355}, {347, 298, 431, 0, 0}, {347, 300, 355, 0, 0}, {169, 213, 298, 298, 0}, {347, 0, 0, 0, 0}, {347, 300, 0, 0, 0}, {284, 169, 345, 266, 312}, {169, 137, 404, 267, 173}, {169, 213, 298, 173, 0}, {169, 170, 172, 268, 173}, {189, 88, 209, 126, 126}, {169, 181, 267, 173, 126}, {285, 345, 432, 337, 126}, {285, 345, 433, 339, 126}, {347, 298, 334, 0, 0}, {335, 258, 126, 126, 0}, {347, 186, 355, 0, 0}, {283, 284, 434, 321, 322}, {284, 157, 435, 293, 294},
		{284, 169, 286, 296, 297}, {283, 284, 423, 424, 288}, {436, 437, 438, 425, 425}, {437, 423, 438, 439, 426}, {437, 285, 425, 439, 429}, {437, 434, 440, 441, 442}, {437, 285, 439, 426, 427}, {285, 286, 439, 429, 431}, {285, 347, 352, 431, 0}, {284, 357, 443, 444, 415}, {169, 137, 445, 172, 268}, {169, 181, 266, 209, 126}, {437, 285, 446, 432, 337}, {285, 286, 446, 339, 334}, {285, 347, 352, 334, 0}, {285, 345, 339, 334, 126}, {161, 447, 166, 167, 168}, {438, 446, 346, 221, 0}, {333, 352, 89, 0, 0}, {333, 126, 0, 0, 0}, {335, 358, 448, 89, 89},
		{335, 260, 344, 126, 0}, {333, 344, 126, 0, 0}, {335, 221, 89, 0, 0}, {333, 89, 0, 0, 0}, {165, 356, 449, 167, 168}, {285, 308, 450, 333, 334}, {451, 346, 221, 0, 0}, {333, 89, 89, 0, 0}, {333, 126, 126, 0, 0}, {335, 258, 352, 89, 0}, {452, 221, 0, 0, 0}, {347, 298, 352, 0, 0}, {437, 285, 333, 352, 352}, {285, 286, 333, 355, 355}, {285, 347, 352, 355, 0}, {285, 345, 453, 454, 126}, {333, 355, 126, 0, 0}, {285, 347, 126, 126, 0}, {347, 298, 126, 0, 0}, {333, 0, 0, 0, 0}, {165, 189, 358, 180, 89},
		{165, 207, 286, 359, 180}, {335, 338, 454, 126, 126}, {335, 336, 455, 89, 126}, {117, 118, 397, 456, 124}, {285, 347, 344, 344, 0}, {335, 258, 355, 126, 0}, {285, 347, 89, 89, 0}, {285, 345, 221, 89, 0}, {335, 221, 0, 0, 0}, {366, 457, 368, 369, 458}, {36, 459, 371, 275, 229}, {401, 460, 461, 462, 463}, {376, 464, 377, 89, 126}, {72, 465, 242, 190, 89}, {117, 204, 400, 120, 126}, {401, 460, 466, 467, 468}, {117, 243, 469, 86, 126}, {87, 125, 221, 89, 0}, {403, 468, 89, 0, 0}, {376, 470, 378, 89, 89}, {403, 468, 126, 0, 0},
		{403, 468, 124, 0, 0}, {403, 468, 121, 0, 0}, {380, 471, 232, 39, 123}, {169, 181, 346, 221, 0}, {93, 401, 236, 472, 473}, {53, 117, 299, 390, 391}, {117, 236, 474, 398, 475}, {117, 403, 273, 475, 0}, {284, 169, 347, 298, 298}, {169, 137, 297, 300, 300}, {169, 213, 298, 300, 0}, {117, 403, 273, 273, 0}, {169, 213, 300, 300, 0}, {213, 273, 300, 0, 0}, {213, 0, 0, 0, 0}, {117, 389, 476, 456, 392}, {87, 125, 477, 89, 126}, {169, 213, 186, 186, 0}, {189, 190, 300, 126, 0}, {169, 213, 89, 89, 0}, {213, 273, 0, 0, 0},
		{399, 478, 258, 89, 89}, {189, 346, 221, 0, 0}, {401, 479, 472, 473, 480}, {376, 464, 481, 89, 126}, {403, 480, 273, 0, 0}, {335, 258, 431, 89, 0}, {101, 72, 340, 210, 74}, {284, 482, 483, 449, 167}, {165, 207, 308, 484, 269}, {165, 189, 336, 209, 89}, {284, 357, 485, 486, 345}, {437, 487, 451, 488, 448}, {285, 286, 489, 343, 344}, {285, 345, 337, 344, 126}, {285, 308, 446, 337, 334}, {285, 163, 343, 344, 126}, {335, 258, 344, 126, 0}, {256, 490, 104, 105, 198}, {285, 347, 0, 0, 0}, {285, 289, 427, 352, 355}, {285, 289, 429, 355, 355},
		{283, 316, 491, 492, 493}, {436, 494, 495, 496, 497}, {437, 423, 498, 438, 425}, {437, 434, 499, 500, 439}, {437, 434, 501, 502, 442}, {438, 439, 346, 221, 126}, {438, 333, 126, 126, 0}, {333, 352, 126, 0, 0}, {438, 333, 0, 0, 0}, {333, 352, 0, 0, 0}, {438, 439, 221, 89, 126}, {333, 355, 0, 0, 0}, {451, 343, 126, 126, 0}, {451, 221, 0, 0, 0}, {437, 285, 425, 425, 333}, {437, 285, 430, 441, 333}, {436, 503, 504, 505, 506}, {437, 423, 506, 438, 425}, {438, 425, 507, 221, 89}, {438, 333, 89, 89, 0}, {438, 425, 221, 89, 89},
		{438, 439, 221, 126, 126}, {438, 333, 89, 126, 0}, {508, 335, 448, 352, 89}, {285, 163, 343, 355, 126}, {285, 345, 455, 431, 126}, {451, 448, 89, 89, 0}, {161, 399, 257, 258, 89}, {333, 344, 89, 0, 0}, {285, 163, 509, 454, 126}, {438, 446, 221, 89, 0}, {451, 488, 221, 89, 89}, {452, 507, 0, 0, 0}, {451, 221, 126, 0, 0}, {333, 89, 126, 0, 0}, {333, 344, 0, 0, 0}, {213, 273, 126, 0, 0}, {366, 510, 511, 512, 513}, {376, 514, 515, 126, 126}, {36, 516, 517, 379, 89}, {401, 518, 519, 481, 126}, {117, 243, 346, 221, 0},
		{403, 480, 89, 0, 0}, {403, 126, 0, 0, 0}, {376, 520, 468, 126, 0}, {521, 517, 190, 89, 89}, {117, 243, 522, 277, 126}, {403, 480, 124, 0, 0}, {403, 126, 126, 0, 0}, {189, 120, 126, 126, 0}, {376, 514, 248, 126, 126}, {380, 523, 371, 275, 229}, {117, 389, 524, 398, 392}, {403, 480, 475, 0, 0}, {169, 213, 301, 301, 0}, {213, 392, 0, 0, 0}, {169, 213, 126, 126, 0}, {213, 121, 0, 0, 0}, {399, 525, 260, 126, 126}, {401, 526, 527, 528, 529}, {403, 529, 392, 0, 0}, {403, 468, 392, 0, 0}, {165, 175, 530, 163, 178},
		{508, 335, 488, 448, 89}, {335, 336, 221, 89, 0}, {508, 531, 439, 532, 454}, {285, 308, 439, 429, 334}, {508, 533, 425, 489, 448}, {451, 509, 221, 126, 126}, {451, 534, 221, 89, 126}, {256, 521, 242, 190, 89}, {436, 437, 535, 499, 500}, {437, 423, 535, 440, 441}, {437, 285, 425, 430, 333}, {436, 437, 506, 506, 438}, {536, 505, 452, 507, 507}, {505, 506, 452, 346, 346}, {505, 438, 507, 346, 221}, {505, 535, 452, 507, 346}, {505, 438, 346, 346, 221}, {438, 425, 346, 221, 89}, {505, 438, 221, 89, 89}, {438, 425, 221, 126, 126}, {436, 494, 537, 538, 535},
		{536, 539, 540, 541, 542}, {505, 506, 543, 452, 507}, {505, 535, 542, 452, 346}, {452, 346, 0, 0, 0}, {508, 544, 545, 489, 488}, {451, 221, 89, 0, 0}, {366, 546, 547, 548, 89}, {401, 402, 549, 249, 126}, {376, 548, 468, 89, 0}, {376, 221, 126, 0, 0}, {376, 221, 89, 0, 0}, {403, 89, 0, 0, 0}, {550, 547, 379, 89, 89}, {87, 549, 120, 126, 126}, {376, 548, 480, 89, 0}, {87, 249, 392, 126, 0}, {551, 89, 89, 0, 0}, {521, 552, 190, 89, 89}, {189, 221, 0, 0, 0}, {380, 550, 517, 379, 89}, {169, 213, 0, 0, 0},
		{399, 452, 221, 0, 0}, {401, 551, 480, 480, 0}, {117, 403, 392, 392, 0}, {403, 480, 392, 0, 0}, {403, 0, 0, 0, 0}, {285, 308, 439, 427, 334}, {285, 163, 488, 448, 89}, {451, 448, 126, 126, 0}, {285, 308, 553, 333, 344}, {451, 343, 89, 126, 0}, {505, 438, 507, 507, 221}, {536, 504, 554, 541, 543}, {536, 505, 542, 542, 452}, {505, 506, 542, 452, 507}, {536, 505, 543, 543, 452}, {555, 541, 0, 0, 0}, {541, 543, 0, 0, 0}, {541, 452, 0, 0, 0}, {541, 542, 0, 0, 0}, {508, 483, 556, 446, 453}, {438, 553, 507, 221, 89},
		{546, 557, 548, 89, 89}, {376, 558, 249, 126, 126}, {551, 559, 468, 0, 0}, {87, 346, 221, 0, 0}, {550, 560, 379, 89, 89}, {551, 561, 480, 0, 0}, {521, 562, 120, 126, 126}, {438, 446, 346, 221, 126}, {555, 540, 0, 0, 0}, {555, 554, 0, 0, 0}, {438, 489, 346, 221, 126}, {546, 563, 520, 126, 126}, {376, 346, 221, 0, 0}, {551, 126, 126, 0, 0}, {550, 564, 249, 126, 126}, {551, 565, 529, 0, 0}, {521, 452, 221, 0, 0}, {546, 566, 221, 0, 0}, {550, 452, 221, 0, 0}, {551, 0, 0, 0, 0}, {566, 566, 0, 0, 0}
	};
}

int n;
int c[N], fact[N * 4], finv[N * 4];
int dp[2][N * 4][S], (*cur)[S] = *dp, (*nxt)[S] = dp[1];

ll PowerMod(ll a, int n, ll c = 1) {for (; n; n &gt;&gt;= 1, a = a * a % mod) if (n &amp; 1) c = c * a % mod; return c;}

void init(int n) {
	int i;
	for (*fact = i = 1; i &lt;= n; ++i) fact[i] = (ll)fact[i - 1] * i % mod;
	finv[n] = PowerMod(fact[n], mod - 2);
	for (i = n; i; --i) finv[i - 1] = (ll)finv[i] * i % mod;
}

int main() {
	int i, j, ni, nj, d, w, S, tot; ll s;
	scanf("%d", &amp;n), init(4 * n);
	for (i = 0; i &lt; 13; ++i) scanf("%d%*d", &amp;w), ++c[--w];
	for (nxt[0][1] = 1, w = 0; w &lt; n; ++w) {
		std::swap(cur, nxt), memset(nxt, 0, sizeof *dp), tot += c[w];
		for (i = 0; i &lt;= 4 * w; ++i)
			for (j = 1; j &lt;= MAM::cnt; ++j) if ((s = cur[i][j]))
				for (d = 0; d &lt;= 4 - c[w]; ++d)
					ni = i + c[w] + d, nj = MAM::d[j][c[w] + d],
					nj &amp;&amp; (nxt[ni][nj] = (nxt[ni][nj] + s * C[4 - c[w]][d]) % mod);
	}
	for (S = 0, i = 13; i &lt; 4 * n; ++i)
		s = std::accumulate(nxt[i] + 1, nxt[i] + MAM::cnt, 0ll) % mod,
		S = (S + s * fact[i - 13] % mod * fact[4 * n - i]) % mod;
	printf("%lld\n", (ll)S * finv[4 * n - 13] % mod);
	return 0;
}

</code></pre></div>

		<h3>坑</h3>
		<p><strong>坑1：</strong>在自动机上搜索的时候，状态可以压到一个 $64$ 位整数 (<code>long long</code>) 中，这样顺便也可以使用 <code>unordered_map</code> (<samp>hash_map</samp>)。</p>
		<p><strong>坑2：</strong>由于我们要统计的是<strong>不胡</strong>的方案数，因此如果自动机转移到了终止节点 (胡牌节点)，则是不能更新 DP 数组的。</p>
		<script>syntax_highlight()</script>
	</body>
</html>
