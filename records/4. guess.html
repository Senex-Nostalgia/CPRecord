<link type="text/css" rel="stylesheet" href="../additional_files/css/bootstrap.min.css">
<link type="text/css" rel="stylesheet" href="../additional_files/css/sh_typical.min.css">
<script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]}});</script>
<script type="text/javascript" src="../additional_files/MathJax-master/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<h3>题目描述</h3>
<p>你正在和 scx 玩一个猜数字的游戏。</p>
<p>scx 首先生成一个长为 $n$ 的整数序列 $a_1, a_2, \cdots, a_n$。在每一轮游戏中，小冰会给出一个区间范围 $[l, r]$，然后你要猜一个数 $k$。如果 $k$ 在 $a_l, a_{l+1}, \cdots, a_r$ 中，那么你获胜。</p>
<p>在尝试了几轮之后，你发现这个游戏太(wu)难(liao)了，scx
决定给你一些提示：你每猜一次，她会告诉你 <strong>$k$ 与 $a_l, a_{l+1}, \cdots, a_r$ 中最接近的数的差的绝对值</strong>，即 $\min\limits_{l \leq i \leq r}|a_i - k|$。</p>
<p>现在，请你实现这个新功能。</p>

<h3>输入格式</h3>
<p>第一行包含两个整数 $n$ 和 $q$ ($1 \leq n, q \leq 3 \times 10^5$)。</p>
<p>第二行包含 $n$ 个由空格分开的整数，分别代表 $a_1, a_2, \cdots, a_n$ ($0 \leq a_i \leq 10^9$)。</p>
<p>接下来 $q$ 行，每行三个由空格隔开的整数 $l, r, k$。</p>

<h3>输出格式</h3>
<p>对每个询问输出一行，每行为一个整数，即为所求的值。</p>

<h3>题解</h3>
<p>好像这并不是标算……(然而这道题可以出成在线？)</p>
<p>考虑使用可持久化线段树，第 $i$ 个 timestamp (时间戳) 记录 $a_1, a_2, \cdots, a_i$ 中 $0$ 到 $10^9$ 中各出现了几次 (可持久化线段树的大小为 $10^9$，因此要<strong>动态开点</strong>或离散化)。</p>
<p>询问 $l, r$ 的时候，我们只需将 timestamp 为 $r$ 的线段树与 timestamp 为 $l - 1$ 的线段树相减，就得到了 $a_l, a_{l+1}, \cdots, a_r$ 对应的线段树。</p>
<p>然后只需实现查找对于某一个节点，它的上一个 (值) 非 $0$ 节点 (<code>Lower()</code>) 和下一个非 $0$ 节点 (<code>Upper()</code>)。</p>
<p>然后就可以用类似于 <a href="../index.html?redirect=60" target="_blank">[NOI2017] 整数</a>的方法，只是加了一个可持久化而已，就举个 <code>Lower()</code> 的例子吧：</p>
<p>先考虑从线段树的根到该节点的路径，如果该节点有值，就返回该节点，从下到上依次找<strong>方向为右</strong>的节点。</p>
<p>如果它的左兄弟节点有非 $0$ 节点，则在这个左节点上贪心地<strong>向下</strong>寻找；如果所有<strong>方向为右</strong>的节点所对应的左兄弟节点都没有非 $0$ 节点，则它<strong>没有前趋</strong>。</p>
<p>最后取它与前趋的差，和后继与它的差的较小值就是答案。</p>

<h3>代码</h3>

<div class="panel-body"><pre class="sh_sourceCode"><code class="sh_cpp"><span class="sh_preproc">#include</span> <span class="sh_string">&lt;bits/stdc++.h&gt;</span>
<span class="sh_preproc">#define</span> N <span class="sh_number">341468</span>
<span class="sh_preproc">#define</span> C <span class="sh_number">10244040</span>
<span class="sh_preproc">#define</span> RANGE <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_number">1000000000</span>
<span class="sh_preproc">#define</span> <span class="sh_usertype">ID</span><span class="sh_normal"> </span><span class="sh_function">isdigit</span><span class="sh_symbol">(</span>c <span class="sh_symbol">=</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">++)</span>
<span class="sh_preproc">#define</span> <span class="sh_usertype">RT</span><span class="sh_normal"> </span><span class="sh_keyword">if</span><span class="sh_symbol">(</span>c <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_keyword">return</span> flag <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span>
<span class="sh_keyword">using</span> <span class="sh_keyword">namespace</span> std<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">Istream</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> flag<span class="sh_symbol">;</span> <span class="sh_type">char</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">,</span> buf<span class="sh_symbol">[</span><span class="sh_number">17073400</span><span class="sh_symbol">];</span>
    <span class="sh_type">void</span> <span class="sh_function">init</span><span class="sh_symbol">(</span><span class="sh_usertype">FILE</span><span class="sh_normal"> </span><span class="sh_symbol">*</span>f <span class="sh_symbol">=</span> stdin<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">fread</span><span class="sh_symbol">(</span>buf<span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_keyword">sizeof</span> buf<span class="sh_symbol">,</span> f<span class="sh_symbol">);</span> next <span class="sh_symbol">=</span> buf<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    Istream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_type">int</span> c<span class="sh_symbol">,</span> l <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(;</span> <span class="sh_symbol">!</span>ID<span class="sh_symbol">;</span> l <span class="sh_symbol">=</span> c<span class="sh_symbol">)</span> RT<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>x <span class="sh_symbol">=</span> c <span class="sh_symbol">-</span> <span class="sh_number">48</span><span class="sh_symbol">;</span> ID<span class="sh_symbol">;</span> x <span class="sh_symbol">=</span> x <span class="sh_symbol">*</span> <span class="sh_number">10</span> <span class="sh_symbol">+</span> <span class="sh_symbol">(</span>c <span class="sh_symbol">-</span> <span class="sh_number">48</span><span class="sh_symbol">))</span> RT<span class="sh_symbol">;</span> RT<span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>l <span class="sh_symbol">==</span> <span class="sh_number">45</span><span class="sh_symbol">)</span> x <span class="sh_symbol">=</span> <span class="sh_symbol">-</span>x<span class="sh_symbol">;</span>
        <span class="sh_keyword">return</span> flag <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_type">char</span> <span class="sh_function">get</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_symbol">*</span>next<span class="sh_symbol">++;</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">operator</span> <span class="sh_type">void</span> <span class="sh_symbol">*()</span> <span class="sh_cbracket">{</span><span class="sh_keyword">return</span> flag <span class="sh_symbol">?</span> <span class="sh_keyword">this</span> <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>Cin<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">Ostream</span><span class="sh_cbracket">{</span>
    FILE <span class="sh_symbol">*</span>_f<span class="sh_symbol">;</span> <span class="sh_type">char</span> buf<span class="sh_symbol">[</span><span class="sh_number">34</span><span class="sh_symbol">];</span>
    <span class="sh_type">void</span> <span class="sh_function">init</span><span class="sh_symbol">(</span><span class="sh_usertype">FILE</span><span class="sh_normal"> </span><span class="sh_symbol">*</span>f <span class="sh_symbol">=</span> stdout<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>_f <span class="sh_symbol">=</span> f<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    Ostream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">int</span> x<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(!</span>x<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> <span class="sh_function">put</span><span class="sh_symbol">(</span><span class="sh_number">48</span><span class="sh_symbol">),</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">if</span><span class="sh_symbol">(</span>x <span class="sh_symbol">&lt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">put</span><span class="sh_symbol">(</span><span class="sh_number">45</span><span class="sh_symbol">);</span> x <span class="sh_symbol">=</span> <span class="sh_symbol">-</span>x<span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
        <span class="sh_type">int</span> i<span class="sh_symbol">;</span>
        <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x <span class="sh_symbol">&gt;</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> x <span class="sh_symbol">/=</span> <span class="sh_number">10</span><span class="sh_symbol">)</span> buf<span class="sh_symbol">[</span>i<span class="sh_symbol">++]</span> <span class="sh_symbol">=</span> x <span class="sh_symbol">%</span> <span class="sh_number">10</span> <span class="sh_symbol">+</span> <span class="sh_number">48</span><span class="sh_symbol">;</span>
        <span class="sh_keyword">while</span><span class="sh_symbol">(--</span>i <span class="sh_symbol">&gt;=</span> <span class="sh_number">0</span><span class="sh_symbol">)</span> <span class="sh_function">put</span><span class="sh_symbol">(</span>buf<span class="sh_symbol">[</span>i<span class="sh_symbol">]);</span>
        <span class="sh_keyword">return</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    Ostream<span class="sh_symbol">&amp;</span> <span class="sh_keyword">operator</span> <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">char</span> c<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_keyword">return</span> <span class="sh_function">put</span><span class="sh_symbol">(</span>c<span class="sh_symbol">),</span> <span class="sh_symbol">*</span><span class="sh_keyword">this</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>
    <span class="sh_type">void</span> <span class="sh_function">put</span><span class="sh_symbol">(</span><span class="sh_type">char</span> c<span class="sh_symbol">)</span><span class="sh_cbracket">{</span><span class="sh_function">fputc</span><span class="sh_symbol">(</span>c<span class="sh_symbol">,</span> _f<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
<span class="sh_cbracket">}</span>Cout<span class="sh_symbol">;</span>

<span class="sh_keyword">struct</span><span class="sh_normal"> </span><span class="sh_classname">node</span><span class="sh_cbracket">{</span><span class="sh_type">int</span> lc<span class="sh_symbol">,</span> rc<span class="sh_symbol">,</span> v<span class="sh_symbol">;</span><span class="sh_cbracket">}</span> x<span class="sh_symbol">[</span>C<span class="sh_symbol">];</span>

<span class="sh_type">int</span> cnt <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> tim <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">,</span> root<span class="sh_symbol">[</span>N<span class="sh_symbol">];</span>

<span class="sh_type">int</span> n<span class="sh_symbol">,</span> q<span class="sh_symbol">,</span> i<span class="sh_symbol">;</span>
<span class="sh_type">int</span> l<span class="sh_symbol">,</span> r<span class="sh_symbol">,</span> k<span class="sh_symbol">;</span>
<span class="sh_type">unsigned</span> ans<span class="sh_symbol">;</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">down</span><span class="sh_symbol">(</span><span class="sh_type">unsigned</span> <span class="sh_symbol">&amp;</span>x<span class="sh_symbol">,</span> <span class="sh_keyword">const</span> <span class="sh_type">unsigned</span> y<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>x <span class="sh_symbol">&gt;</span> y <span class="sh_symbol">?</span> x <span class="sh_symbol">=</span> y <span class="sh_symbol">:</span> <span class="sh_number">0</span><span class="sh_symbol">;</span><span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">add</span><span class="sh_symbol">(</span><span class="sh_type">int</span> _id<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">,</span> <span class="sh_type">int</span> h<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_type">int</span> id <span class="sh_symbol">=</span> <span class="sh_symbol">++</span>cnt<span class="sh_symbol">;</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> x<span class="sh_symbol">[</span>_id<span class="sh_symbol">];</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>v <span class="sh_symbol">+=</span> v<span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">==</span> R<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> id<span class="sh_symbol">;</span>
    <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>h <span class="sh_symbol">&lt;=</span> M<span class="sh_symbol">)</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>lc <span class="sh_symbol">=</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">,</span> h<span class="sh_symbol">,</span> v<span class="sh_symbol">);</span>
    <span class="sh_keyword">else</span> x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>rc <span class="sh_symbol">=</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>id<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">,</span> h<span class="sh_symbol">,</span> v<span class="sh_symbol">);</span>
    <span class="sh_keyword">return</span> id<span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">Lrange</span><span class="sh_symbol">(</span><span class="sh_type">int</span> lid<span class="sh_symbol">,</span> <span class="sh_type">int</span> rid<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">==</span> R<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> L<span class="sh_symbol">;</span> <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">return</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v <span class="sh_symbol">-</span> x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v <span class="sh_symbol">?</span> <span class="sh_function">Lrange</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">)</span> <span class="sh_symbol">:</span> <span class="sh_function">Lrange</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">Urange</span><span class="sh_symbol">(</span><span class="sh_type">int</span> lid<span class="sh_symbol">,</span> <span class="sh_type">int</span> rid<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">==</span> R<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> L<span class="sh_symbol">;</span> <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">return</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v <span class="sh_symbol">-</span> x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v <span class="sh_symbol">?</span> <span class="sh_function">Urange</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">)</span> <span class="sh_symbol">:</span> <span class="sh_function">Urange</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">Lower</span><span class="sh_symbol">(</span><span class="sh_type">int</span> lid<span class="sh_symbol">,</span> <span class="sh_type">int</span> rid<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">,</span> <span class="sh_type">int</span> h<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">==</span> R<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>v <span class="sh_symbol">-</span> x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>v <span class="sh_symbol">?</span> <span class="sh_number">0</span> <span class="sh_symbol">:</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> r<span class="sh_symbol">;</span>
    r <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>h <span class="sh_symbol">&gt;</span> M <span class="sh_symbol">?</span> <span class="sh_function">Lower</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">,</span> h<span class="sh_symbol">)</span> <span class="sh_symbol">:</span> <span class="sh_function">Lower</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">,</span> h<span class="sh_symbol">));</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(~</span>r<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> r<span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>h <span class="sh_symbol">&gt;</span> M <span class="sh_symbol">&amp;&amp;</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v <span class="sh_symbol">-</span> x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> h <span class="sh_symbol">-</span> <span class="sh_function">Lrange</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">);</span>
    <span class="sh_keyword">return</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">Upper</span><span class="sh_symbol">(</span><span class="sh_type">int</span> lid<span class="sh_symbol">,</span> <span class="sh_type">int</span> rid<span class="sh_symbol">,</span> <span class="sh_type">int</span> L<span class="sh_symbol">,</span> <span class="sh_type">int</span> R<span class="sh_symbol">,</span> <span class="sh_type">int</span> h<span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>L <span class="sh_symbol">==</span> R<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>v <span class="sh_symbol">-</span> x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>v <span class="sh_symbol">?</span> <span class="sh_number">0</span> <span class="sh_symbol">:</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_type">int</span> M <span class="sh_symbol">=</span> L <span class="sh_symbol">+</span> R <span class="sh_symbol">-</span> <span class="sh_number">1</span> <span class="sh_symbol">&gt;&gt;</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> r<span class="sh_symbol">;</span>
    r <span class="sh_symbol">=</span> <span class="sh_symbol">(</span>h <span class="sh_symbol">&gt;</span> M <span class="sh_symbol">?</span> <span class="sh_function">Upper</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">,</span> h<span class="sh_symbol">)</span> <span class="sh_symbol">:</span> <span class="sh_function">Upper</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>lc<span class="sh_symbol">,</span> L<span class="sh_symbol">,</span> M<span class="sh_symbol">,</span> h<span class="sh_symbol">));</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(~</span>r<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> r<span class="sh_symbol">;</span>
    <span class="sh_keyword">if</span><span class="sh_symbol">(</span>h <span class="sh_symbol">&lt;=</span> M <span class="sh_symbol">&amp;&amp;</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v <span class="sh_symbol">-</span> x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">[</span>x<span class="sh_symbol">].</span>v<span class="sh_symbol">)</span> <span class="sh_keyword">return</span> <span class="sh_function">Urange</span><span class="sh_symbol">(</span>x<span class="sh_symbol">[</span>lid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> x<span class="sh_symbol">[</span>rid<span class="sh_symbol">].</span>rc<span class="sh_symbol">,</span> M <span class="sh_symbol">+</span> <span class="sh_number">1</span><span class="sh_symbol">,</span> R<span class="sh_symbol">)</span> <span class="sh_symbol">-</span> h<span class="sh_symbol">;</span>
    <span class="sh_keyword">return</span> <span class="sh_symbol">-</span><span class="sh_number">1</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

<span class="sh_keyword">inline</span> <span class="sh_type">void</span> <span class="sh_function">add</span><span class="sh_symbol">(</span><span class="sh_type">int</span> h<span class="sh_symbol">,</span> <span class="sh_type">int</span> v<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span><span class="sh_symbol">++</span>tim<span class="sh_symbol">;</span> root<span class="sh_symbol">[</span>tim<span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>root<span class="sh_symbol">[</span>tim <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">],</span> RANGE<span class="sh_symbol">,</span> h<span class="sh_symbol">,</span> v<span class="sh_symbol">);</span><span class="sh_cbracket">}</span>

<span class="sh_type">int</span> <span class="sh_function">main</span><span class="sh_symbol">()</span><span class="sh_cbracket">{</span>
    Cin<span class="sh_symbol">.</span><span class="sh_function">init</span><span class="sh_symbol">();</span> Cout<span class="sh_symbol">.</span><span class="sh_function">init</span><span class="sh_symbol">();</span>
    Cin <span class="sh_symbol">&gt;&gt;</span> n <span class="sh_symbol">&gt;&gt;</span> q<span class="sh_symbol">;</span>
    root<span class="sh_symbol">[</span><span class="sh_number">0</span><span class="sh_symbol">]</span> <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span>
    <span class="sh_keyword">for</span><span class="sh_symbol">(</span>i <span class="sh_symbol">=</span> <span class="sh_number">1</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;=</span> n<span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>Cin <span class="sh_symbol">&gt;&gt;</span> k<span class="sh_symbol">;</span> <span class="sh_function">add</span><span class="sh_symbol">(</span>k<span class="sh_symbol">,</span> <span class="sh_number">1</span><span class="sh_symbol">);</span><span class="sh_cbracket">}</span>
    <span class="sh_keyword">while</span><span class="sh_symbol">(</span>q <span class="sh_symbol">--&gt;</span> <span class="sh_number">0</span><span class="sh_symbol">)</span><span class="sh_cbracket">{</span>
        Cin <span class="sh_symbol">&gt;&gt;</span> l <span class="sh_symbol">&gt;&gt;</span> r <span class="sh_symbol">&gt;&gt;</span> k<span class="sh_symbol">;</span> ans <span class="sh_symbol">=</span> UINT_MAX<span class="sh_symbol">;</span>
        <span class="sh_function">down</span><span class="sh_symbol">(</span>ans<span class="sh_symbol">,</span> <span class="sh_function">Lower</span><span class="sh_symbol">(</span>root<span class="sh_symbol">[</span>l <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">],</span> root<span class="sh_symbol">[</span>r<span class="sh_symbol">],</span> RANGE<span class="sh_symbol">,</span> k<span class="sh_symbol">));</span>
        <span class="sh_function">down</span><span class="sh_symbol">(</span>ans<span class="sh_symbol">,</span> <span class="sh_function">Upper</span><span class="sh_symbol">(</span>root<span class="sh_symbol">[</span>l <span class="sh_symbol">-</span> <span class="sh_number">1</span><span class="sh_symbol">],</span> root<span class="sh_symbol">[</span>r<span class="sh_symbol">],</span> RANGE<span class="sh_symbol">,</span> k<span class="sh_symbol">));</span>
        Cout <span class="sh_symbol">&lt;&lt;</span> <span class="sh_symbol">(</span><span class="sh_type">int</span><span class="sh_symbol">)</span>ans <span class="sh_symbol">&lt;&lt;</span> <span class="sh_string">'</span><span class="sh_specialchar">\n</span><span class="sh_string">'</span><span class="sh_symbol">;</span>
    <span class="sh_cbracket">}</span>
    <span class="sh_keyword">return</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>
<span class="sh_cbracket">}</span>

</code></pre></div>

<h3>坑</h3>
<p><strong>坑1：</strong>这题非常卡空间……只有 $128 \mathrm{M}$ 的空间，最后衡量了一下，可持久化线段树要开到 $9.5 \times 10^6$ 个节点，多了要 MLE，少了就要 RE，然后 (如果用 <code>fread()</code> 的话) 读入优化的数组也不能太大，$8.5 \times 10^6$ 个字节足矣。</p>
<p><strong>坑2：</strong><code>Lower()</code> 和 <code>Upper()</code> (<code>Lrange()</code> 和 <code>Urange()</code>) 的代码虽然非常像，但也要长点心眼，因为有很多是对称着要改变的，不要漏掉 (不然会 WA 掉的)。</p>
